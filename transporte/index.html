<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horarios de Transporte - Crom Studio</title>
    
    <!-- JS de PapaParse (CDN - para leer los .txt/CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Importar Fuente (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS (Con estilos para Tarifas) -->
    <style>
        :root {
            --color-primario: #0d6efd;
            --color-fondo: #f8f9fa;
            --color-tarjeta: #ffffff;
            --color-texto: #212529;
            --color-texto-secundario: #6c757d;
            --color-borde: #dee2e6;
            --color-hover: #f1f3f5;
            --color-activo: #e7f1ff;
            --color-proximo: #fff3cd;
            --color-proximo-texto: #856404;
            --color-proximo-borde: #ffeeba;
            --color-alerta-bg: #f8d7da;
            --color-alerta-texto: #721c24;
            --color-alerta-borde: #f5c6cb;
            --color-info-bg: #cce5ff;
            --color-info-texto: #004085;
            --color-info-borde: #b8daff;
            --color-obra-bg: #d4edda;
            --color-obra-texto: #155724;
            --color-obra-borde: #c3e6cb;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        #app-container {
            width: 100%; height: 100%;
            display: flex;
            background: var(--color-tarjeta);
        }
        .panel {
            border-right: 1px solid var(--color-borde);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-shrink: 0;
        }
        #panel-rutas { width: 320px; }
        #panel-paradas { width: 360px; }
        #panel-detalles {
            width: auto;
            flex-grow: 1;
            border-right: none;
        }
        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-borde);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .panel-header h2 {
            margin: 0; font-size: 20px; color: #111;
        }
        .back-button {
            display: none;
            font-size: 24px; font-weight: 600;
            text-decoration: none; color: var(--color-primario);
            line-height: 1;
        }
        .panel-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 8px 0;
        }
        .list-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: background-color 0.15s ease-out;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background-color: var(--color-hover); }
        .list-item.active {
            background-color: var(--color-activo);
            box-shadow: inset 4px 0 0 var(--color-primario);
            padding-left: 20px;
        }
        .list-item .icon { font-size: 20px; flex-shrink: 0; }
        .list-item div { flex-grow: 1; }
        .list-item strong {
            font-size: 16px; font-weight: 600;
            color: var(--color-texto); display: block;
        }
        .list-item span {
            font-size: 14px; color: var(--color-texto-secundario);
        }
        
        /* --- Estilos de Novedades y Tarifas --- */
        .novedades-container {
            padding: 16px;
            background: #fdfdfd;
            border-bottom: 1px solid var(--color-borde);
            flex-shrink: 0;
            max-height: 35%;
            overflow-y: auto;
        }
        .novedades-container h3 {
            font-size: 16px;
            margin: 0 0 12px 0;
            color: var(--color-texto);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-borde);
        }
        .novedad-item {
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--color-borde);
        }
        .novedad-item:last-child { margin-bottom: 0; }
        
        .novedad-item strong {
            display: block;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        .novedad-item p {
            font-size: 14px;
            margin: 0;
            color: var(--color-texto-secundario);
        }
        .chip {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            border-radius: 12px;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .tipo-ALERTA { background-color: var(--color-alerta-bg); color: var(--color-alerta-texto); border: 1px solid var(--color-alerta-borde); }
        .tipo-INFO { background-color: var(--color-info-bg); color: var(--color-info-texto); border: 1px solid var(--color-info-borde); }
        .tipo-OBRA { background-color: var(--color-obra-bg); color: var(--color-obra-texto); border: 1px solid var(--color-obra-borde); }

        /* NUEVO: Estilo para la Tarifa */
        #tarifa-info {
            padding: 16px;
            background: var(--color-activo);
            border-bottom: 1px solid var(--color-borde);
            flex-shrink: 0;
        }
        #tarifa-info h3 {
            font-size: 16px;
            margin: 0 0 8px 0;
            color: var(--color-primario);
        }
        #tarifa-info p {
            font-size: 15px;
            color: var(--color-texto);
            margin: 0;
            line-height: 1.5;
            white-space: pre-wrap; /* Respeta los saltos de l칤nea */
        }
        /* --- Fin Estilos Novedades/Tarifa --- */

        #horarios-panel-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #horarios-container {
            padding: 24px;
            flex-grow: 1;
            overflow-y: auto;
        }
        #reloj-actual {
            font-size: 16px; font-weight: 500;
            color: var(--color-texto-secundario);
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px dashed var(--color-borde);
        }
        #reloj-actual span {
            font-family: monospace; font-size: 1.1em;
            color: var(--color-texto); background: #eee;
            padding: 4px 8px; border-radius: 4px;
            margin-left: 8px;
        }
        #proximo-bus-resumen {
            display: none;
            margin-bottom: 24px;
        }
        #proximo-bus-resumen h3 {
            font-size: 18px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .horario-item.proximo-resumen {
            background-color: var(--color-proximo);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-proximo-borde);
        }
        .horario-item.proximo-resumen .hora {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-proximo-texto);
        }
        .horario-item.proximo-resumen .destino {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-proximo-texto);
        }
        #titulo-lista-horarios {
            font-size: 18px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 10px;
            display: none;
        }
        .horario-item {
            padding: 14px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .horario-item:last-child { border-bottom: none; }
        .horario-item .hora {
            font-family: monospace; font-size: 20px;
            font-weight: 700; color: var(--color-texto);
        }
        .horario-item .destino {
            font-size: 16px; font-weight: 500;
            text-align: right; color: var(--color-texto-secundario);
        }
        .horario-item.proximo {
            background-color: var(--color-proximo);
            margin: 0 -24px;
            padding: 14px 24px;
            border-radius: 6px;
        }
        .horario-item.proximo .hora { color: var(--color-proximo-texto); }
        .horario-item.proximo .destino {
            color: var(--color-proximo-texto); font-weight: 600;
        }
        #detalles-placeholder {
            text-align: center; padding: 60px 20px;
            color: var(--color-texto-secundario);
        }
        #detalles-placeholder .icon {
            font-size: 48px; margin-bottom: 16px;
        }
        #estado-carga {
            padding: 20px; font-size: 16px;
            font-weight: 500; text-align: center;
        }
        .status-loading { color: #555; }
        .status-error { color: #dc3545; background: #fff0f0; padding: 20px; }
        
        #debug-log {
            display: none; /* Panel de diagn칩stico oculto */
            flex-shrink: 0;
            background: #2b2b2b;
            color: #f1f1f1;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 2px solid var(--color-borde);
        }
        .log-info { color: #80caff; }
        .log-ok { color: #a5d6a7; }
        .log-warn { color: #ffcc80; }
        .log-error { color: #ef9a9a; }
        
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
                height: 100vh;
            }
            .panel {
                width: 100% !important;
                height: 100%;
                border-right: none;
                border-bottom: 1px solid var(--color-borde);
                display: none;
            }
            #panel-rutas { display: flex; }
            .back-button { display: block; }
            .panel-header { padding: 16px; }
            #debug-log { height: 100px; }
        }
    </style>
</head>
<body>

    <!-- ===== ESTRUCTURA DE LA APLICACI칍N ===== -->
    <div id="app-container">
        
        <!-- Panel Izquierdo: Rutas -->
        <div id="panel-rutas" class="panel">
            <div class="panel-header"> <h2>游뚧 Rutas</h2> </div>
            
            <div id="novedades-generales-container" class="novedades-container" style="display: none;">
                <h3>游닊 Novedades Generales</h3>
                <div id="novedades-generales-lista"></div>
            </div>
            
            <div id="estado-carga" class="status-loading">
                Cargando archivos GTFS...
            </div>
            <div class="panel-list" id="lista-rutas"></div>
        </div>

        <!-- Panel Central: Paradas -->
        <div id="panel-paradas" class="panel">
            <div class="panel-header">
                <a href="#" class="back-button" id="back-a-rutas" aria-label="Volver a Rutas">&lsaquo;</a>
                <h2 id="paradas-titulo">游늸 Paradas</h2>
            </div>
            
            <!-- NUEVO: Contenedor de Tarifa -->
            <div id="tarifa-info" style="display: none;">
                <h3>游 Tarifa y Pago</h3>
                <p id="tarifa-descripcion"></p>
            </div>
            
            <div id="novedades-ruta-container" class="novedades-container" style="display: none;">
                <h3>游닊 Novedades de la Ruta</h3>
                <div id="novedades-ruta-lista"></div>
            </div>
            
            <div class="panel-list" id="lista-paradas"></div>
        </div>

        <!-- Panel Derecho: Horarios de la Parada Seleccionada -->
        <div id="panel-detalles" class="panel">
            <div class="panel-header">
                <a href="#" class="back-button" id="back-a-paradas" aria-label="Volver a Paradas">&lsaquo;</a>
                <h2 id="detalles-titulo">游 Horarios</h2>
            </div>
            
            <div id="horarios-panel-content">
                <div id="horarios-container">
                    <div id="detalles-placeholder">
                        <div class="icon">游녣</div>
                        Seleccione una ruta y luego una parada.
                    </div>
                    <div id="reloj-actual" style="display:none;">
                        D칤a (Venezuela): <span id="reloj-dia">--</span> | Hora: <span id="reloj-hora">--:--:--</span>
                    </div>
                    <div id="proximo-bus-resumen" style="display: none;">
                        <h3>Pr칩ximo Autob칰s</h3>
                        <div class="horario-item proximo-resumen">
                            <span class="hora" id="proximo-hora">--:--:--</span>
                            <span class="destino" id="proximo-destino">Cargando...</span>
                        </div>
                    </div>
                    <h3 id="titulo-lista-horarios" style="display: none;">Todos los Horarios</h3>
                    <div id="horarios-lista"></div>
                </div>
                
                <pre id="debug-log">Iniciando panel de diagn칩stico...</pre>
            </div>
        </div>
    </div>

    <!-- ===== SCRIPT DE LA APLICACI칍N ===== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- CONFIGURACI칍N ---
            const gtfsBaseUrl = "https://cromstudio.com.ve/transporte/";
            const diasSemanaGTFS = {
                "domingo": "sunday", "lunes": "monday", "martes": "tuesday",
                "miercoles": "wednesday", "jueves": "thursday", "viernes": "friday", "sabado": "saturday"
            };
            
            // --- DOM REFS ---
            const dom = {
                estadoCarga: document.getElementById("estado-carga"),
                panelRutas: document.getElementById("panel-rutas"),
                listaRutas: document.getElementById("lista-rutas"),
                panelParadas: document.getElementById("panel-paradas"),
                paradasTitulo: document.getElementById("paradas-titulo"),
                listaParadas: document.getElementById("lista-paradas"),
                backARutas: document.getElementById("back-a-rutas"),
                panelDetalles: document.getElementById("panel-detalles"),
                detallesTitulo: document.getElementById("detalles-titulo"),
                detallesPlaceholder: document.getElementById("detalles-placeholder"),
                backAParadas: document.getElementById("back-a-paradas"),
                relojContainer: document.getElementById("reloj-actual"),
                relojDia: document.getElementById("reloj-dia"),
                relojHora: document.getElementById("reloj-hora"),
                horariosLista: document.getElementById("horarios-lista"),
                debugLog: document.getElementById("debug-log"),
                proximoResumen: document.getElementById("proximo-bus-resumen"),
                proximoHora: document.getElementById("proximo-hora"),
                proximoDestino: document.getElementById("proximo-destino"),
                tituloListaHorarios: document.getElementById("titulo-lista-horarios"),
                novedadesGeneralesContainer: document.getElementById("novedades-generales-container"),
                novedadesGeneralesLista: document.getElementById("novedades-generales-lista"),
                novedadesRutaContainer: document.getElementById("novedades-ruta-container"),
                novedadesRutaLista: document.getElementById("novedades-ruta-lista"),
                
                // Nuevos DOM de Tarifa
                tarifaInfo: document.getElementById("tarifa-info"),
                tarifaDescripcion: document.getElementById("tarifa-descripcion")
            };

            // --- DB & ESTADO ---
            const db = {
                routes: new Map(), trips: new Map(),
                stops: new Map(), calendar: new Map(),
                stopTimes: [], noticias: [],
                tarifas: new Map(), // <-- Nueva DB de tarifas
                agencyTimezone: "America/Caracas"
            };
            let relojIntervalo = null;
            let estadoApp = {
                rutaActiva: null, paradaActiva: null,
                diaActualGTFS_Field: 'monday',
                fechaActualYYYYMMDD: 20250101
            };
            const esMovil = () => window.innerWidth <= 768;

            // --- LOGGING ---
            function logDebug(message, type = 'info') {
                /* Oculto */
            }

            // --- INICIALIZACI칍N ---
            async function main() {
                try {
                    logDebug("Iniciando carga de archivos GTFS...");
                    const parseFile = (fileName) => {
                        return new Promise((resolve, reject) => {
                            Papa.parse(gtfsBaseUrl + fileName, {
                                download: true, header: true,
                                dynamicTyping: true, skipEmptyLines: true,
                                complete: (results) => {
                                    if (results.errors.length > 0) logDebug(`Errores de parseo en ${fileName}`, 'warn');
                                    logDebug(`Archivo ${fileName} cargado: ${results.data.length} filas`, 'ok');
                                    resolve(results.data);
                                },
                                error: (err) => reject(new Error(`Error de red al cargar ${fileName}. 쮼xiste y es p칰blico?`))
                            });
                        });
                    };

                    // A침adir tarifas.txt al Promise.all
                    const [agency, routes, stops, trips, stopTimes, calendar, noticias, tarifas] = await Promise.all([
                        parseFile("agency.txt"), parseFile("routes.txt"),
                        parseFile("stops.txt"), parseFile("trips.txt"),
                        parseFile("stop_times.txt"), parseFile("calendar.txt"),
                        parseFile("noticias.txt"),
                        parseFile("tarifas.txt") // <-- Cargar el nuevo archivo
                    ]);

                    // Procesar
                    if (agency.length > 0) db.agencyTimezone = agency[0].agency_timezone || "America/Caracas";
                    routes.forEach(r => db.routes.set(r.route_id, r));
                    stops.forEach(s => db.stops.set(s.stop_id, s));
                    trips.forEach(t => db.trips.set(t.trip_id, t));
                    calendar.forEach(c => db.calendar.set(c.service_id, c));
                    db.stopTimes = stopTimes;
                    db.noticias = noticias.sort((a, b) => new Date(b.fecha_publicacion) - new Date(a.fecha_publicacion));
                    // Procesar tarifas
                    tarifas.forEach(t => db.tarifas.set(t.route_id, t.descripcion_tarifa));

                    logDebug("Base de datos en memoria creada.", 'ok');
                    dom.estadoCarga.style.display = "none";
                    
                    renderizarNovedadesGenerales();
                    renderizarListaRutas();
                    iniciarReloj();
                    configurarNavegacion();
                    mostrarPanel('panel-rutas');

                } catch (error) {
                    console.error("Error fatal en main():", error);
                    dom.estadoCarga.textContent = `Error al cargar: ${error.message}`;
                    dom.estadoCarga.className = "status-error";
                    logDebug(error.message, 'error');
                }
            }

            // --- NAVEGACI칍N ---
            function mostrarPanel(panelId) {
                if (!esMovil()) {
                    dom.panelRutas.style.display = "flex";
                    dom.panelParadas.style.display = "flex";
                    dom.panelDetalles.style.display = "flex";
                    return;
                }
                ['panel-rutas', 'panel-paradas', 'panel-detalles'].forEach(id_css => {
                    const el = document.getElementById(id_css);
                    if (el) el.style.display = (id_css === panelId) ? 'flex' : 'none';
                });
            }
            
            function configurarNavegacion() {
                dom.backARutas.addEventListener('click', (e) => { e.preventDefault(); mostrarPanel('panel-rutas'); });
                dom.backAParadas.addEventListener('click', (e) => { e.preventDefault(); mostrarPanel('panel-paradas'); });
            }

            // --- L칍GICA DE TIEMPO ---
            function aSegundos(horaStr) {
                if (!horaStr || typeof horaStr !== 'string' || horaStr.split(':').length < 3) return 0;
                try {
                    const [h, m, s] = horaStr.split(':').map(Number);
                    return (h * 3600) + (m * 60) + s;
                } catch (e) { return 0; }
            }

            function iniciarReloj() {
                dom.relojContainer.style.display = "block";
                
                const actualizarHora = () => {
                    const ahora = new Date();
                    
                    const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: db.agencyTimezone };
                    const horaFormato = new Intl.DateTimeFormat('es-VE', opcionesHora).format(ahora);
                    
                    const opcionesDia = { weekday: 'long', timeZone: db.agencyTimezone };
                    const diaNombreConAcento = new Intl.DateTimeFormat('es-VE', opcionesDia).format(ahora);
                    const diaNombreLimpio = diaNombreConAcento.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    estadoApp.diaActualGTFS_Field = diasSemanaGTFS[diaNombreLimpio] || 'monday';
                    
                    const ymdFormatter = new Intl.DateTimeFormat('en-CA', { timeZone: db.agencyTimezone, year: 'numeric', month: '2-digit', day: '2-digit' });
                    const [y, m, d] = ymdFormatter.format(ahora).split('-');
                    estadoApp.fechaActualYYYYMMDD = parseInt(`${y}${m}${d}`, 10);
                    
                    dom.relojDia.textContent = diaNombreConAcento.charAt(0).toUpperCase() + diaNombreConAcento.slice(1);
                    dom.relojHora.textContent = horaFormato;
                    
                    if (estadoApp.paradaActiva) {
                        renderizarHorarios(estadoApp.paradaActiva, true);
                    }
                };
                
                if (relojIntervalo) clearInterval(relojIntervalo);
                actualizarHora();
                relojIntervalo = setInterval(actualizarHora, 1000);
            }

            // --- RENDERIZADO (CON NOVEDADES Y TARIFA) ---
            
            function crearHtmlNovedad(novedad) {
                const tipo = novedad.tipo || 'INFO';
                const titulo = novedad.trip_headsign 
                    ? `${novedad.titulo} (${novedad.trip_headsign})`
                    : novedad.titulo;
                
                return `
                    <div class="novedad-item tipo-${tipo}">
                        <strong><span class="chip tipo-${tipo}">${tipo}</span>${titulo}</strong>
                        <p>${novedad.descripcion}</p>
                    </div>
                `;
            }

            function renderizarNovedadesGenerales() {
                const noticiasGenerales = db.noticias.filter(n => !n.route_id);
                if (noticiasGenerales.length > 0) {
                    dom.novedadesGeneralesLista.innerHTML = noticiasGenerales.map(crearHtmlNovedad).join('');
                    dom.novedadesGeneralesContainer.style.display = 'block';
                } else {
                    dom.novedadesGeneralesContainer.style.display = 'none';
                }
            }
            
            function renderizarNovedadesDeRuta(routeId) {
                const noticiasDeRuta = db.noticias.filter(n => n.route_id === routeId);
                if (noticiasDeRuta.length > 0) {
                    dom.novedadesRutaLista.innerHTML = noticiasDeRuta.map(crearHtmlNovedad).join('');
                    dom.novedadesRutaContainer.style.display = 'block';
                } else {
                    dom.novedadesRutaContainer.style.display = 'none';
                }
            }

            function renderizarListaRutas() {
                dom.listaRutas.innerHTML = '';
                db.routes.forEach(route => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游뚧</span>
                        <div>
                            <strong>${route.route_short_name || 'Ruta'}</strong>
                            <span>${route.route_long_name}</span>
                        </div>
                    `;
                    div.addEventListener('click', () => {
                        document.querySelectorAll('#lista-rutas .list-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        estadoApp.rutaActiva = route.route_id;
                        logDebug(`Ruta seleccionada: ${route.route_long_name}`, 'info');
                        
                        renderizarNovedadesDeRuta(route.route_id);
                        renderizarListaParadas(route.route_id);
                    });
                    dom.listaRutas.appendChild(div);
                });
            }

            function renderizarListaParadas(routeId) {
                const route = db.routes.get(routeId);
                dom.paradasTitulo.textContent = `游늸 Paradas de ${route.route_short_name}`;

                // --- A칌ADIDO: Mostrar Tarifa ---
                const descripcionTarifa = db.tarifas.get(routeId);
                if (descripcionTarifa) {
                    dom.tarifaDescripcion.textContent = descripcionTarifa;
                    dom.tarifaInfo.style.display = 'block';
                } else {
                    dom.tarifaInfo.style.display = 'none';
                }
                // --- FIN ---

                const viajesRuta = [...db.trips.values()].filter(t => t.route_id === routeId);
                const idsViajesRuta = new Set(viajesRuta.map(t => t.trip_id));
                
                const idsParadas = new Set();
                const paradasOrdenadas = [];
                const primerViaje = viajesRuta.length > 0 ? viajesRuta[0].trip_id : null;
                
                if(primerViaje) {
                    db.stopTimes
                        .filter(st => st.trip_id === primerViaje)
                        .sort((a,b) => a.stop_sequence - b.stop_sequence)
                        .forEach(st => {
                            if (!idsParadas.has(st.stop_id)) {
                                paradasOrdenadas.push(st.stop_id);
                                idsParadas.add(st.stop_id);
                            }
                        });
                }
                
                dom.listaParadas.innerHTML = '';
                paradasOrdenadas.forEach(stopId => {
                    const stop = db.stops.get(stopId);
                    if (!stop) return;
                    
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游늸</span>
                        <div><strong>${stop.stop_name}</strong></div>
                    `;
                    div.addEventListener('click', () => {
                        document.querySelectorAll('#lista-paradas .list-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        estadoApp.paradaActiva = stop.stop_id;
                        logDebug(`Parada seleccionada: ${stop.stop_name}`, 'info');
                        renderizarHorarios(stop.stop_id, false);
                    });
                    dom.listaParadas.appendChild(div);
                });
                
                dom.detallesPlaceholder.style.display = "block";
                dom.horariosLista.innerHTML = '';
                dom.proximoResumen.style.display = 'none';
                dom.tituloListaHorarios.style.display = 'none';
                
                mostrarPanel('panel-paradas');
            }

            /** Muestra los horarios para una parada */
            function renderizarHorarios(stopId, esRefresco = false) {
                if (!esRefresco) {
                    const stop = db.stops.get(stopId);
                    dom.detallesTitulo.textContent = `游 ${stop.stop_name}`;
                    dom.detallesPlaceholder.style.display = "none";
                    dom.horariosLista.innerHTML = '';
                    dom.debugLog.innerHTML = 'Refrescando horarios...';
                    mostrarPanel('panel-detalles');
                }

                const horaActualStr = dom.relojHora.textContent;
                const segundosActuales = aSegundos(horaActualStr);
                const diaActualField = estadoApp.diaActualGTFS_Field;
                const fechaActual = estadoApp.fechaActualYYYYMMDD;

                if (!esRefresco) {
                    logDebug(`Hora actual (${db.agencyTimezone}): ${horaActualStr} (${segundosActuales}s)`, 'info');
                    logDebug(`D칤a (campo GTFS): ${diaActualField}`, 'info');
                    logDebug(`Fecha (GTFS): ${fechaActual}`, 'info');
                }

                const idsViajesRutaActiva = new Set(
                    [...db.trips.values()]
                        .filter(t => t.route_id === estadoApp.rutaActiva)
                        .map(t => t.trip_id)
                );

                const horariosHoy = db.stopTimes
                    .filter(st => {
                        if (st.stop_id !== stopId) return false;
                        if (!idsViajesRutaActiva.has(st.trip_id)) return false;
                        
                        const trip = db.trips.get(st.trip_id);
                        if (!trip) return false;
                        
                        const calendario = db.calendar.get(trip.service_id);
                        if (!calendario) {
                            if (!esRefresco) logDebug(`ERROR: service_id "${trip.service_id}" (del trip "${trip.trip_id}") no se encuentra en calendar.txt`, 'error');
                            return false;
                        }

                        const esDiaValido = calendario[diaActualField] === 1;
                        const estaEnRango = fechaActual >= calendario.start_date && fechaActual <= calendario.end_date;

                        return esDiaValido && estaEnRango;
                    })
                    .map(st => ({
                        hora: st.departure_time,
                        destino: db.trips.get(st.trip_id).trip_headsign || "Sin destino"
                    }))
                    .sort((a, b) => a.hora.localeCompare(b.hora));

                const horariosUnicos = [];
                const visto = new Set();
                for (const h of horariosHoy) {
                    const id = h.hora + h.destino;
                    if (!visto.has(id)) {
                        horariosUnicos.push(h);
                        visto.add(id);
                    }
                }
                
                if (!esRefresco) {
                    logDebug(`Se encontraron ${horariosUnicos.length} salidas 칰nicas para hoy.`, 'ok');
                }
                
                let proximoBus = null;
                for (const h of horariosUnicos) {
                    if (aSegundos(h.hora) > segundosActuales) {
                        proximoBus = h;
                        break;
                    }
                }

                if (proximoBus) {
                    dom.proximoHora.textContent = proximoBus.hora;
                    dom.proximoDestino.textContent = proximoBus.destino;
                    dom.proximoResumen.style.display = 'block';
                    dom.tituloListaHorarios.style.display = 'block';
                    if (!esRefresco) logDebug(`Pr칩ximo bus: ${proximoBus.hora}`, 'ok');
                } else {
                    dom.proximoResumen.style.display = 'none';
                    dom.tituloListaHorarios.style.display = 'none';
                }

                dom.horariosLista.innerHTML = '';
                let busesPasados = 0;
                
                horariosUnicos.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'horario-item';
                    
                    const segundosBus = aSegundos(h.hora);
                    
                    if (proximoBus && h.hora === proximoBus.hora && h.destino === proximoBus.destino) {
                        div.classList.add('proximo');
                    }
                    
                    if (segundosBus <= segundosActuales) {
                        busesPasados++;
                    }
                    
                    div.innerHTML = `
                        <span class="hora">${h.hora}</span>
                        <span class="destino">${h.destino}</span>
                    `;
                    dom.horariosLista.appendChild(div);
                });
                
                const msgSinMasSalidas = 'No hay m치s salidas programadas para hoy.';
                const msgSinSalidasHoy = `No hay salidas programadas para hoy (verifique el d칤a y el rango de fechas del servicio).`;
                
                if (!proximoBus && horariosUnicos.length > 0) {
                     dom.horariosLista.innerHTML = `<div class="horario-item" style="text-align: center; color: var(--color-texto-secundario); padding: 20px 0;">${msgSinMasSalidas}</div>`;
                     if (!esRefresco) logDebug(msgSinMasSalidas, 'warn');
                } else if (horariosUnicos.length === 0) {
                     dom.horariosLista.innerHTML = `<div class="horario-item" style="text-align: center; color: var(--color-texto-secundario); padding: 20px 0;">${msgSinSalidasHoy}</div>`;
                     if (!esRefresco) logDebug(msgSinSalidasHoy, 'warn');
                }
            }

            // --- INICIAR ---
            main();
            window.addEventListener('resize', () => mostrarPanel(esMovil() ? 'panel-rutas' : 'panel-rutas'));
        });
    </script>
</body>
</html>