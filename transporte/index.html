<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horarios y Mapa v20 - Crom Studio</title>
    
    <!-- JS de PapaParse (CDN - para leer los .txt/CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Importar Fuente (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
          
    <!-- API de Google Maps con tu API Key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxQnqhHh_H7IGHH5p5bow2Bz8iPIIqRww&libraries=routes"></script>

    <!-- CSS (Con estilos para Nuevas Funciones) -->
    <style>
        :root {
            --color-primario: #0d6efd;
            --color-fondo: #f8f9fa;
            --color-tarjeta: #ffffff;
            --color-texto: #212529;
            --color-texto-secundario: #6c757d;
            --color-borde: #dee2e6;
            --color-hover: #f1f3f5;
            --color-activo: #e7f1ff;
            --color-proximo: #fff3cd;
            --color-proximo-texto: #856404;
            --color-proximo-borde: #ffeeba;
            --color-alerta-bg: #f8d7da;
            --color-alerta-texto: #721c24;
            --color-alerta-borde: #f5c6cb;
            --color-info-bg: #cce5ff;
            --color-info-texto: #004085;
            --color-info-borde: #b8daff;
            --color-obra-bg: #d4edda;
            --color-obra-texto: #155724;
            --color-obra-borde: #c3e6cb;
            --color-exito-bg: #d1e7dd;
            --color-exito-texto: #0f5132;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column; /* Para la barra de navegaci칩n */
        }
        
        /* --- Barra de Navegaci칩n --- */
        #main-nav {
            flex-shrink: 0;
            background: var(--color-tarjeta);
            border-bottom: 1px solid var(--color-borde);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 0 10px;
        }
        #main-nav ul {
            margin: 0;
            padding: 0;
            display: flex;
            list-style: none;
            flex-wrap: nowrap; /* Evita que se rompa la l칤nea */
            overflow-x: auto; /* Permite scroll horizontal en m칩vil */
            -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
        }
        #main-nav li a {
            display: block;
            padding: 16px 12px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            color: var(--color-texto-secundario);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        #main-nav li a:hover {
            color: var(--color-texto);
        }
        #main-nav li a.active {
            color: var(--color-primario);
            border-bottom-color: var(--color-primario);
        }
        /* --- Fin Barra de Navegaci칩n --- */

        #app-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* --- Contenedor Principal (Layout) --- */
        #visor-horarios {
            width: 100%; height: 100%;
            display: flex;
            background: var(--color-tarjeta);
        }
        
        /* --- Contenedor del Mapa --- */
        #visor-mapa {
            width: 100%;
            height: 100%;
            display: none; /* Oculto por defecto */
            position: relative;
        }
        #mapa-principal {
            width: 100%;
            height: 100%;
        }
        
        /* --- Contenedores de Pesta침as Simples --- */
        #visor-planificador, #visor-reportes, #visor-acerca-de, #visor-desarrollo, #visor-cerca-de-mi, #visor-directorio {
            width: 100%;
            height: 100%;
            display: none; /* Oculto por defecto */
            padding: 24px;
            overflow-y: auto;
        }
        .simple-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .form-container {
            background: var(--color-tarjeta);
            border: 1px solid var(--color-borde);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .form-container h2, #acerca-de-content h2, #desarrollo-content h2 {
            font-size: 24px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 20px;
        }
        .form-container label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            background: #fff;
            margin-bottom: 16px;
        }
        .form-container textarea {
            min-height: 120px;
            font-family: 'Inter', sans-serif;
        }
        .form-container button {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .form-container button:hover {
            background: #0b5ed7;
        }
        
        /* --- Contenido Pesta침as Nuevas --- */
        #acerca-de-content p, #desarrollo-content p, #desarrollo-content li {
            font-size: 16px;
            line-height: 1.7;
            color: var(--color-texto-secundario);
            margin-bottom: 16px;
        }
        #acerca-de-content h3, #desarrollo-content h3 {
            font-size: 20px;
            color: var(--color-texto);
            margin-top: 24px;
            margin-bottom: 12px;
        }
        #acerca-de-logo {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        #acerca-de-logo svg {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
        }
        #desarrollo-content pre {
            background: #2b2b2b;
            color: #f1f1f1;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }

        /* --- Planificador --- */
        #planificador-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }
        #planificador-resultados {
            margin-top: 24px;
        }
        #planificador-resultados h2 {
            font-size: 22px;
            color: var(--color-texto);
            margin-bottom: 16px;
        }
        #planificador-resultados h2.manana {
            color: var(--color-proximo-texto);
            background: var(--color-proximo);
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
        }
        .resultado-viaje {
            background: var(--color-tarjeta);
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .resultado-viaje h3 {
            background: var(--color-activo);
            padding: 16px 20px;
            margin: 0;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
        }
        .resultado-viaje h3 span {
            font-weight: 500;
            color: var(--color-texto-secundario);
        }
        .resultado-viaje h3 .tarifa-total {
            font-weight: 700;
            color: var(--color-primario);
        }
        
        .resultado-viaje .detalles {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 16px;
            font-size: 16px;
        }
        .resultado-viaje .hora {
            font-size: 22px;
            font-weight: 700;
            font-family: monospace;
        }
        .resultado-viaje .parada {
            font-weight: 600;
        }
        .resultado-viaje .duracion {
            text-align: center;
            font-size: 14px;
            color: var(--color-texto-secundario);
        }
        .transbordo-conector {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primario);
            padding: 16px;
            background: var(--color-fondo);
            border-top: 1px dashed var(--color-borde);
            border-bottom: 1px dashed var(--color-borde);
        }
        /* --- Fin Planificador --- */

        /* --- Panel Horarios --- */
        .panel {
            border-right: 1px solid var(--color-borde);
            display: flex;
            flex-direction: column;
            height: 100%;
            flex-shrink: 0;
        }
        #panel-rutas { width: 320px; }
        #panel-paradas { width: 360px; }
        #panel-detalles {
            width: auto;
            flex-grow: 1;
            border-right: none;
        }
        .panel-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-borde);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-shrink: 0;
        }
        .panel-header h2 {
            margin: 0; font-size: 20px; color: #111;
        }
        .back-button {
            display: none;
            font-size: 24px; font-weight: 600;
            text-decoration: none; color: var(--color-primario);
            line-height: 1;
        }
        
        .panel-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 8px 0;
        }
        .list-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: background-color 0.15s ease-out;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { 
            background-color: var(--color-hover);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .list-item.active {
            background-color: var(--color-activo);
            box-shadow: inset 4px 0 0 var(--color-primario);
            padding-left: 20px;
        }
        .list-item .icon { font-size: 20px; flex-shrink: 0; }
        .list-item div { flex-grow: 1; }
        .list-item strong {
            font-size: 16px; font-weight: 600;
            color: var(--color-texto); display: block;
        }
        .list-item span {
            font-size: 14px; color: var(--color-texto-secundario);
        }
        
        /* --- Novedades y Tarifas --- */
        .novedades-container {
            padding: 16px;
            background: #fdfdfd;
            border-bottom: 1px solid var(--color-borde);
            flex-shrink: 0;
            max-height: 35%;
            overflow-y: auto;
        }
        .novedades-container h3 {
            font-size: 16px;
            margin: 0 0 12px 0;
            color: var(--color-texto);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-borde);
        }
        .novedad-item {
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--color-borde);
        }
        .novedad-item:last-child { margin-bottom: 0; }
        
        .novedad-item strong {
            display: block;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        .novedad-item p {
            font-size: 14px;
            margin: 0;
            color: var(--color-texto-secundario);
        }
        .chip {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            border-radius: 12px;
            text-transform: uppercase;
            margin-right: 8px;
        }
        .tipo-ALERTA { background-color: var(--color-alerta-bg); color: var(--color-alerta-texto); border: 1px solid var(--color-alerta-borde); }
        .tipo-INFO { background-color: var(--color-info-bg); color: var(--color-info-texto); border: 1px solid var(--color-info-borde); }
        .tipo-OBRA { background-color: var(--color-obra-bg); color: var(--color-obra-texto); border: 1px solid var(--color-obra-borde); }

        #tarifa-info {
            padding: 16px;
            background: var(--color-activo);
            border-bottom: 1px solid var(--color-borde);
            flex-shrink: 0;
        }
        #tarifa-info h3 {
            font-size: 16px;
            margin: 0 0 8px 0;
            color: var(--color-primario);
        }
        #tarifa-info p {
            font-size: 15px;
            color: var(--color-texto);
            margin: 0;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        #horarios-panel-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #horarios-container {
            padding: 24px;
            flex-grow: 1;
            overflow-y: auto;
        }
        #reloj-actual {
            font-size: 16px; font-weight: 500;
            color: var(--color-texto-secundario);
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px dashed var(--color-borde);
        }
        #reloj-actual span {
            font-family: monospace; font-size: 1.1em;
            color: var(--color-texto); background: #eee;
            padding: 4px 8px; border-radius: 4px;
            margin-left: 8px;
        }
        #proximo-bus-resumen {
            display: none;
            margin-bottom: 24px;
        }
        #proximo-bus-resumen h3 {
            font-size: 18px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .horario-item.proximo-resumen {
            background-color: var(--color-proximo);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-proximo-borde);
        }
        .horario-item.proximo-resumen .hora {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-proximo-texto);
        }
        .horario-item.proximo-resumen .destino {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-proximo-texto);
        }
        #titulo-lista-horarios {
            font-size: 18px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 10px;
            display: none;
        }
        .horario-item {
            padding: 14px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .horario-item:last-child { border-bottom: none; }
        .horario-item .hora {
            font-family: monospace; font-size: 20px;
            font-weight: 700; color: var(--color-texto);
        }
        .horario-item .destino {
            font-size: 16px; font-weight: 500;
            text-align: right; color: var(--color-texto-secundario);
        }
        .horario-item.proximo {
            background-color: var(--color-proximo);
            margin: 0 -24px;
            padding: 14px 24px;
            border-radius: 6px;
        }
        .horario-item.proximo .hora { color: var(--color-proximo-texto); }
        .horario-item.proximo .destino {
            color: var(--color-proximo-texto); font-weight: 600;
        }
        #detalles-placeholder {
            text-align: center; padding: 60px 20px;
            color: var(--color-texto-secundario);
        }
        #detalles-placeholder .icon {
            font-size: 48px; margin-bottom: 16px;
        }
        #estado-carga {
            padding: 20px; font-size: 16px;
            font-weight: 500; text-align: center;
        }
        .status-loading { color: #555; }
        .status-error { color: #dc3545; background: #fff0f0; padding: 20px; }
        
        #debug-log {
            display: none; /* Panel de diagn칩stico oculto */
            flex-shrink: 0;
            background: #2b2b2b;
            color: #f1f1f1;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 2px solid var(--color-borde);
        }
        .log-info { color: #80caff; }
        .log-ok { color: #a5d6a7; }
        .log-warn { color: #ffcc80; }
        .log-error { color: #ef9a9a; }

        /* --- Filtro de Agencias --- */
        #agency-filter-container {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-borde);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .agency-filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-borde);
            background: none;
            color: var(--color-texto-secundario);
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .agency-filter-btn:hover {
            background: var(--color-hover);
        }
        .agency-filter-btn.active {
            background: var(--color-primario);
            color: white;
            border-color: var(--color-primario);
        }
        
        /* --- "Otras Rutas" en Parada --- */
        #otras-rutas-container {
            margin-top: 24px;
            display: none; /* Oculto por defecto */
        }
        #otras-rutas-container h3 {
            font-size: 18px;
            color: var(--color-texto);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .otra-ruta-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--color-borde);
            margin-bottom: 8px;
        }
        .otra-ruta-item .icon {
            font-size: 18px;
        }
        .otra-ruta-item span {
            font-weight: 500;
        }
        
        /* --- "Paradas Cerca de M칤" --- */
        #cerca-de-mi-btn-container {
            padding: 24px;
            text-align: center;
        }
        #btn-buscar-cercanas {
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            background: var(--color-primario);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        #btn-buscar-cercanas:hover {
            background: #0b5ed7;
        }
        #cercanas-resultados-lista .list-item span {
            color: var(--color-primario);
            font-weight: 600;
        }
        
        /* --- "Directorio de Paradas" --- */
        #directorio-detalle-mapa {
            width: 100%; 
            height: 300px; 
            border-radius: 8px; 
            margin-bottom: 16px; 
            background: #eee;
        }

        @media (max-width: 768px) {
            #main-nav ul {
                justify-content: flex-start; /* Alinear a la izquierda para scroll */
            }
            #main-nav li a {
                padding: 16px 12px;
                font-size: 14px;
            }

            /* --- L칍GICA DE PANEL DESLIZANTE --- */
            #visor-horarios {
                flex-direction: row; /* Mantener horizontal */
                position: relative;
                overflow: hidden;
            }
            .panel {
                width: 100% !important; /* Todos los paneles ocupan el ancho */
                height: 100%;
                border-right: none;
                border-bottom: 1px solid var(--color-borde);
                /* A침adir position absolute y transition */
                position: absolute;
                top: 0;
                left: 0;
                transition: transform 0.3s ease-in-out;
            }
            /* Posiciones iniciales */
            #panel-rutas { 
                transform: translateX(0); 
                z-index: 10;
            }
            #panel-paradas { 
                transform: translateX(100%); 
                z-index: 20;
            }
            #panel-detalles { 
                transform: translateX(100%); 
                z-index: 30;
            }
            
            /* Estados de visibilidad */
            #visor-horarios.show-paradas #panel-rutas {
                transform: translateX(-100%);
            }
            #visor-horarios.show-paradas #panel-paradas {
                transform: translateX(0);
            }
            
            #visor-horarios.show-detalles #panel-paradas {
                transform: translateX(-100%);
            }
            #visor-horarios.show-detalles #panel-detalles {
                transform: translateX(0);
            }
            
            .back-button { display: block; }
            .panel-header { padding: 16px; }
            #debug-log { height: 100px; }
            
            #planificador-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <!-- ===== NUEVA BARRA DE NAVEGACI칍N ===== -->
    <nav id="main-nav">
        <ul>
            <li><a href="#" id="btn-horarios" class="active">Horarios</a></li>
            <li><a href="#" id="btn-mapa">Mapa</a></li>
            <li><a href="#" id="btn-planificador">Planificador</a></li>
            <li><a href="#" id="btn-cerca-de-mi">Cerca de M칤</a></li>
            <li><a href="#" id="btn-directorio">Directorio</a></li> <!-- NUEVO -->
            <li><a href="#" id="btn-reportes">Reportes</a></li>
            <li><a href="#" id="btn-desarrollo">Desarrollo</a></li>
            <li><a href="#" id="btn-acerca-de">Acerca de</a></li>
        </ul>
    </nav>
    
    <!-- ===== CONTENEDOR DE LA APP ===== -->
    <div id="app-wrapper">

        <!-- ===== VISOR DE HORARIOS ===== -->
        <div id="visor-horarios">
            <!-- Panel Izquierdo: Rutas -->
            <div id="panel-rutas" class="panel">
                <div class="panel-header"> <h2>游뚧 Rutas</h2> </div>
                
                <div id="agency-filter-container">
                    <!-- Los botones de filtro se a침adir치n aqu칤 -->
                </div>
                
                <div id="novedades-generales-container" class="novedades-container" style="display: none;">
                    <h3>游닊 Novedades Generales</h3>
                    <div id="novedades-generales-lista"></div>
                </div>
                <div id="estado-carga" class="status-loading">
                    Cargando archivos GTFS...
                </div>
                <div class="panel-list" id="lista-rutas"></div>
            </div>

            <!-- Panel Central: Paradas -->
            <div id="panel-paradas" class="panel">
                <div class="panel-header">
                    <a href="#" class="back-button" id="back-a-rutas" aria-label="Volver a Rutas">&lsaquo;</a>
                    <h2 id="paradas-titulo">游늸 Paradas</h2>
                </div>
                <div id="tarifa-info" style="display: none;">
                    <h3>游 Tarifa y Pago</h3>
                    <p id="tarifa-descripcion"></p>
                </div>
                <div id="novedades-ruta-container" class="novedades-container" style="display: none;">
                    <h3>游닊 Novedades de la Ruta</h3>
                    <div id="novedades-ruta-lista"></div>
                </div>
                <div class="panel-list" id="lista-paradas"></div>
            </div>

            <!-- Panel Derecho: Horarios -->
            <div id="panel-detalles" class="panel">
                <div class="panel-header">
                    <a href="#" class="back-button" id="back-a-paradas" aria-label="Volver a Paradas">&lsaquo;</a>
                    <h2 id="detalles-titulo">游 Horarios</h2>
                </div>
                <div id="horarios-panel-content">
                    <div id="horarios-container">
                        <div id="detalles-placeholder">
                            <div class="icon">游녣</div>
                            Seleccione una ruta y luego una parada.
                        </div>
                        <div id="reloj-actual" style="display:none;">
                            D칤a (Venezuela): <span id="reloj-dia">--</span> | Hora: <span id="reloj-hora">--:--:--</span>
                        </div>
                        
                        <div id="otras-rutas-container" style="display: none;">
                            <h3>Otras rutas en esta parada</h3>
                            <div id="otras-rutas-lista">
                                <!-- Items de otras rutas aqu칤 -->
                            </div>
                        </div>
                        
                        <div id="proximo-bus-resumen" style="display: none;">
                            <h3>Pr칩ximo Autob칰s (Ruta Actual)</h3>
                            <div class="horario-item proximo-resumen">
                                <span class="hora" id="proximo-hora">--:--:--</span>
                                <span class="destino" id="proximo-destino">Cargando...</span>
                            </div>
                        </div>
                        <h3 id="titulo-lista-horarios" style="display: none;">Todos los Horarios (Ruta Actual)</h3>
                        <div id="horarios-lista"></div>
                    </div>
                    <pre id="debug-log">Iniciando panel de diagn칩stico...</pre>
                </div>
            </div>
        </div>
        
        <!-- ===== VISOR DE MAPA (GOOGLE MAPS) ===== -->
        <div id="visor-mapa">
            <div id="mapa-principal"></div>
        </div>
        
        <!-- ===== VISOR PLANIFICADOR (GTFS) ===== -->
        <div id="visor-planificador">
            <div id="planificador-container" class="simple-container">
                <div id="planificador-form" class="form-container">
                    <div>
                        <label for="plan-origen">Desde:</label>
                        <select id="plan-origen">
                            <option value="">Seleccione una parada...</option>
                        </select>
                    </div>
                    <div>
                        <label for="plan-destino">Hasta:</label>
                        <select id="plan-destino">
                            <option value="">Seleccione una parada...</option>
                        </select>
                    </div>
                    <button id="btn-buscar-ruta">Buscar Ruta en Autob칰s</button>
                </div>
                <div id="planificador-resultados">
                    <!-- Los resultados de la b칰squeda aparecer치n aqu칤 -->
                </div>
            </div>
        </div>
        
        <!-- ===== NUEVO: VISOR PARADAS CERCA DE M칈 ===== -->
        <div id="visor-cerca-de-mi">
            <div class="simple-container">
                <div class="form-container">
                    <h2>游니 Paradas Cerca de M칤</h2>
                    <p>Encuentra las paradas de autob칰s m치s cercanas a tu ubicaci칩n actual.</p>
                    <div id="cerca-de-mi-btn-container">
                        <button id="btn-buscar-cercanas">游니 Encontrar mi ubicaci칩n</button>
                    </div>
                    <div id="cercanas-status" style="text-align: center; margin-top: 16px;"></div>
                    <div id="cercanas-resultados-lista" class="panel-list" style="margin-top: 20px;">
                        <!-- Resultados de paradas cercanas -->
                    </div>
                </div>
            </div>
        </div>
        

  <!-- ===== NUEVO: VISOR DIRECTORIO DE PARADAS ===== -->
        <div id="visor-directorio">
            <div class="simple-container">
                <div class="form-container">
                    <h2>游늸 Directorio de Paradas</h2>
                    <p>Seleccione una parada para ver su ubicaci칩n y qu칠 rutas pasan por ella.</p>
                    <div id="directorio-paradas-lista" class="panel-list" style="max-height: 400px; margin-bottom: 24px; border: 1px solid var(--color-borde); border-radius: 8px;">
                        <!-- La lista de todas las paradas se inyectar치 aqu칤 -->
                    </div>
                    
                    <div id="directorio-detalle-container" style="display: none;">
                        <h3 id="directorio-detalle-titulo" style="font-size: 20px;"></h3>
                        <div id="directorio-detalle-mapa" style="width: 100%; height: 300px; border-radius: 8px; margin-bottom: 16px; background: #eee;"></div>
                        <h4>Rutas que pasan por esta parada:</h4>
                        <div id="directorio-detalle-rutas-lista">
                            <!-- La lista de rutas de la parada se inyectar치 aqu칤 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- ===== NUEVO: VISOR REPORTES ===== -->
        <div id="visor-reportes">
            <div id="reporte-container" class="simple-container">
                <!-- FORMULARIO AHORA APUNTA A FORMSPREE -->
                <form id="report-form" class="form-container" action="https://formsubmit.co/soporte@cromstudio.com.ve" method="POST">
                    <h2>Reporte Ciudadano</h2>
                    <p style="margin-top: -10px; margin-bottom: 20px; color: var(--color-texto-secundario);">쯌iste algo incorrecto? 춰Ay칰danos a mejorar!</p>
                    
                    <label for="reporte-tipo">Tipo de Reporte</label>
                    <select id="reporte-tipo" name="tipo_reporte" required>
                        <option value="">Seleccione un tipo...</option>
                        <option value="horario_incorrecto">Horario incorrecto</option>
                        <option value="bus_no_paso">El autob칰s no pas칩</option>
                        <option value="afluencia">Afluencia (bus lleno/vac칤o)</option>
                        <option value="error_app">Error en la aplicaci칩n</option>
                        <option value="otro">Otro</option>
                    </select>
                    
                    <label for="reporte-email">Tu Email (Opcional)</label>
                    <input type="email" id="reporte-email" name="email" placeholder="tu@correo.com">
                    
                    <label for="reporte-mensaje">Mensaje</label>
                    <textarea id="reporte-mensaje" name="mensaje" placeholder="Describe tu reporte..." required></textarea>
                    
                    <button type="submit">Enviar Reporte</button>
                </form>
            </div>
        </div>
        
        <!-- ===== NUEVO: VISOR ACERCA DE ===== -->
        <div id="visor-acerca-de">
            <div id="acerca-de-container" class="simple-container">
                <div id="acerca-de-content" class="form-container">
                    
                    <div id="acerca-de-logo">
                        <!-- Logo SVG simple como placeholder -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--color-primario)">
                            <path d="M18.9 2.1c-1.8-1.8-4.3-2.7-6.9-2.7s-5.1.9-6.9 2.7C3.5 3.7 2.7 5.8 2.7 8v8.3c0 .8.4 1.5 1 1.9.6.4 1.4.6 2.1.6h.2c.2 0 .3 0 .4-.1.7-.1 1.3-.5 1.7-1l1.1-1.4c.1-.2.4-.3.6-.3h4.2c.2 0 .5.1.6.3l1.1 1.4c.4.5 1 1 1.7 1 .1 0 .3.1.4.1h.2c.8 0 1.5-.2 2.1-.6.6-.4 1-1.1 1-1.9V8c0-2.2-.8-4.3-2.4-5.9zM18 16.3c0 .1-.1.3-.3.4-.1.1-.3.1-.4.1h-.2c-.3 0-.7-.1-1-.4l-1.1-1.4c-.4-.5-1-1-1.7-1H8.7c-.7 0-1.3.5-1.7 1l-1.1 1.4c-.3.2-.6.4-1 .4h-.2c-.1 0-.3 0-.4-.1-.1-.1-.3-.2-.3-.4V8c0-1.7.6-3.3 1.9-4.5C8.4 2.2 10.1 1.5 12 1.5s3.6.7 4.9 1.9C18.2 4.7 18.9 6.3 18.9 8v8.3zM8.2 11.2c-.8 0-1.5-.7-1.5-1.5S7.4 8.2 8.2 8.2s1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm7.5 0c-.8 0-1.5-.7-1.5-1.5S15 8.2 15.8 8.2s1.5.7 1.5 1.5-.7 1.5-1.5 1.5z"></path>
                        </svg>
                        <div>
                            <h2>Crom Studio</h2>
                            <p style="margin: 0; font-weight: 600;">Versi칩n: v20</p>
                        </div>
                    </div>
                    
                    <p>Esta aplicaci칩n es un prototipo funcional para la visualizaci칩n de horarios y rutas de transporte p칰blico, desarrollado por <strong>Crom Studio</strong>.</p>
                    <p>Nuestro objetivo es crear una plataforma centralizada, abierta y f치cil de usar que permita a los ciudadanos planificar sus viajes de manera eficiente, acceder a informaci칩n en tiempo real y contribuir a la mejora del servicio.</p>
                    
                    <h3>Nuestra Misi칩n</h3>
                    <p>Creemos en el poder de la tecnolog칤a para transformar la movilidad urbana. Al proporcionar datos claros y accesibles, ayudamos a reducir la incertidumbre, optimizar los tiempos de viaje y fomentar el uso del transporte p칰blico.</p>
                    
                    <h3>Fuente de Datos</h3>
                    <p>Todos los horarios, rutas y paradas se basan en los archivos est치ndar GTFS (General Transit Feed Specification) proporcionados por las agencias de transporte asociadas (Linea Cuatricentenaria, SITSSA, BusPortuguesa).</p>
                    
                    <p style="margin-top: 30px; text-align: center; color: var(--color-texto-secundario);">&copy; 2025 Crom Studio. Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
        
        <!-- ===== NUEVO: VISOR DESARROLLO ===== -->
        <div id="visor-desarrollo">
            <div id="desarrollo-container" class="simple-container">
                <div id="desarrollo-content" class="form-container">
                    <h2>Portal de Desarrolladores</h2>
                    <p>Nuestra plataforma se basa en datos abiertos en el formato est치ndar <strong>GTFS (General Transit Feed Specification)</strong>. Creemos en la colaboraci칩n y en el poder de los datos abiertos para mejorar la movilidad de todos.</p>
                    
                    <h3>Usando Nuestros Datos</h3>
                    <p>Puedes consumir los mismos archivos que usa esta aplicaci칩n para tus propios proyectos. Los datos se actualizan regularmente y est치n disponibles p칰blicamente en las siguientes URLs:</p>
                    <pre>
https://cromstudio.com.ve/transporte/agency.txt
https://cromstudio.com.ve/transporte/stops.txt
https://cromstudio.com.ve/transporte/routes.txt
https://cromstudio.com.ve/transporte/trips.txt
https://cromstudio.com.ve/transporte/stop_times.txt
https://cromstudio.com.ve/transporte/calendar.txt
https://cromstudio.com.ve/transporte/shapes.txt
https://cromstudio.com.ve/transporte/tarifas.txt
https://cromstudio.com.ve/transporte/noticias.txt
</pre>
                    <p>Estos archivos siguen el est치ndar GTFS y pueden ser utilizados en aplicaciones web, m칩viles o sistemas de informaci칩n de transporte.</p>
<a href="https://cromstudio.com.ve/trasporte/desarrollo">En el siguiente enlace, podr치s ver mas informaci칩n sobre el desarrollo usando nuestros datos. </a>                    
                    <h3>Contribuyendo</h3>
                    <p>쮼res una agencia de transporte? 쯄anejas una l칤nea de autobuses y te gustar칤a que tus horarios aparecieran aqu칤? 춰Nos encantar칤a colaborar!</p>
                    <p>Ponte en contacto con nosotros en <strong>soporte@cromstudio.com.ve</strong> para discutir c칩mo podemos integrar tus datos en nuestra plataforma y ayudar a miles de pasajeros.</p>
                </div>
            </div>
        </div>
        
    </div>

    <!-- ===== SCRIPTS ===== -->
    
    <!-- JS de PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SCRIPT DE LA APLICACI칍N (Actualizado con todas las funciones v19) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- CONFIGURACI칍N ---
            const gtfsBaseUrl = "https://cromstudio.com.ve/transporte/";
            const diasSemanaGTFS = {
                "domingo": "sunday", "lunes": "monday", "martes": "tuesday",
                "miercoles": "wednesday", "jueves": "thursday", "viernes": "friday", "sabado": "saturday"
            };
            const MIN_TIEMPO_TRANSBORDO_SEGUNDOS = 20 * 60; // 20 minutos
            const MAX_DISTANCIA_TRANSBORDO_KM = 5; // 5km para transbordos (ej. Guanare a Cabrestero)
            const MAX_DISTANCIA_CERCANA_KM = 2.0; // 2km para "Paradas Cerca de M칤"
            
            // --- DOM REFS ---
            const dom = {
                // Contenedores principales
                visorHorarios: document.getElementById("visor-horarios"),
                visorMapa: document.getElementById("visor-mapa"),
                visorPlanificador: document.getElementById("visor-planificador"),
                visorReportes: document.getElementById("visor-reportes"),
                visorAcercaDe: document.getElementById("visor-acerca-de"),
                visorDesarrollo: document.getElementById("visor-desarrollo"),
                visorCercaDeMi: document.getElementById("visor-cerca-de-mi"),
                btnHorarios: document.getElementById("btn-horarios"),
                btnMapa: document.getElementById("btn-mapa"),
                btnPlanificador: document.getElementById("btn-planificador"),
                btnReportes: document.getElementById("btn-reportes"),
                btnAcercaDe: document.getElementById("btn-acerca-de"),
                btnCercaDeMiNav: document.getElementById("btn-cerca-de-mi"), // Bot칩n de nav
                btnDesarrollo: document.getElementById("btn-desarrollo"),
                btnDirectorio: document.getElementById("btn-directorio"), // A침adido
                visorDirectorio: document.getElementById("visor-directorio"), // A침adido

                // Panel Horarios
                estadoCarga: document.getElementById("estado-carga"),
                panelRutas: document.getElementById("panel-rutas"),
                listaRutas: document.getElementById("lista-rutas"),
                panelParadas: document.getElementById("panel-paradas"),
                paradasTitulo: document.getElementById("paradas-titulo"),
                listaParadas: document.getElementById("lista-paradas"),
                backARutas: document.getElementById("back-a-rutas"),
                panelDetalles: document.getElementById("panel-detalles"),
                detallesTitulo: document.getElementById("detalles-titulo"),
                detallesPlaceholder: document.getElementById("detalles-placeholder"),
                backAParadas: document.getElementById("back-a-paradas"),
                relojContainer: document.getElementById("reloj-actual"),
                relojDia: document.getElementById("reloj-dia"),
                relojHora: document.getElementById("reloj-hora"),
                horariosLista: document.getElementById("horarios-lista"),
                debugLog: document.getElementById("debug-log"),
                proximoResumen: document.getElementById("proximo-bus-resumen"),
                proximoHora: document.getElementById("proximo-hora"),
                proximoDestino: document.getElementById("proximo-destino"),
                tituloListaHorarios: document.getElementById("titulo-lista-horarios"),
                novedadesGeneralesContainer: document.getElementById("novedades-generales-container"),
                novedadesGeneralesLista: document.getElementById("novedades-generales-lista"),
                novedadesRutaContainer: document.getElementById("novedades-ruta-container"),
                novedadesRutaLista: document.getElementById("novedades-ruta-lista"),
                tarifaInfo: document.getElementById("tarifa-info"),
                tarifaDescripcion: document.getElementById("tarifa-descripcion"),
                
                // Nuevos DOM de Filtro y "Otras Rutas"
                agencyFilterContainer: document.getElementById("agency-filter-container"),
                otrasRutasContainer: document.getElementById("otras-rutas-container"),
                otrasRutasLista: document.getElementById("otras-rutas-lista"),
                
                // "Cerca de M칤"
                btnBuscarCercanas: document.getElementById("btn-buscar-cercanas"),
                cercanasStatus: document.getElementById("cercanas-status"),
                cercanasResultadosLista: document.getElementById("cercanas-resultados-lista"),
                
                // Planificador
                planOrigen: document.getElementById("plan-origen"),
                planDestino: document.getElementById("plan-destino"),
                btnBuscarRuta: document.getElementById("btn-buscar-ruta"),
                planResultados: document.getElementById("planificador-resultados"),
                
                // Reportes
                reportForm: document.getElementById("report-form"),

                  // "Directorio"
                directorioParadasLista: document.getElementById("directorio-paradas-lista"),
                directorioDetalleContainer: document.getElementById("directorio-detalle-container"),
                directorioDetalleTitulo: document.getElementById("directorio-detalle-titulo"),
                directorioDetalleMapa: document.getElementById("directorio-detalle-mapa"),
                directorioDetalleRutasLista: document.getElementById("directorio-detalle-rutas-lista"),
            };

            // --- DB & ESTADO ---
            const db = {
                routes: new Map(), trips: new Map(),
                stops: new Map(), calendar: new Map(),
                stopTimes: [], noticias: [],
                tarifas: new Map(), 
                shapes: new Map(), 
                agencies: new Map(),
                agencyTimezone: "America/Caracas",
                stopTimesPorParada: new Map() 
            };
            let relojIntervalo = null;
            let estadoApp = {
                rutaActiva: null, paradaActiva: null,
                diaActualGTFS_Field: 'monday',
                fechaActualYYYYMMDD: 20250101,
                googleMap: null, 
                mapaInicializado: false,
                directorioMapa: null // Mapa para el directorio

            };
            const esMovil = () => window.innerWidth <= 768;

            // --- LOGGING ---
            function logDebug(message, type = 'info') {
                /* Oculto por petici칩n del usuario */
            }

            // --- INICIALIZACI칍N ---
            async function main() {
                try {
                    logDebug("Iniciando carga de archivos GTFS...");
                    const parseFile = (fileName) => {
                        return new Promise((resolve, reject) => {
                            Papa.parse(gtfsBaseUrl + fileName, {
                                download: true, header: true,
                                dynamicTyping: true, skipEmptyLines: true,
                                complete: (results) => {
                                    if (results.errors.length > 0) logDebug(`Errores de parseo en ${fileName}`, 'warn');
                                    logDebug(`Archivo ${fileName} cargado: ${results.data.length} filas`, 'ok');
                                    resolve(results.data);
                                },
                                error: (err) => reject(new Error(`Error de red al cargar ${fileName}. 쮼xiste y es p칰blico?`))
                            });
                        });
                    };

                    const [agency, routes, stops, trips, stopTimes, calendar, noticias, tarifas, shapes] = await Promise.all([
                        parseFile("agency.txt"), parseFile("routes.txt"),
                        parseFile("stops.txt"), parseFile("trips.txt"),
                        parseFile("stop_times.txt"), parseFile("calendar.txt"),
                        parseFile("noticias.txt"), parseFile("tarifas.txt"),
                        parseFile("shapes.txt") 
                    ]);

                    // Procesar
                    if (agency.length > 0) db.agencyTimezone = agency[0].agency_timezone || "America/Caracas";
                    agency.forEach(a => db.agencies.set(a.agency_id, a));
                    routes.forEach(r => db.routes.set(r.route_id, r));
                    stops.forEach(s => db.stops.set(s.stop_id, s));
                    trips.forEach(t => db.trips.set(t.trip_id, t));
                    calendar.forEach(c => db.calendar.set(c.service_id, c));
                    db.stopTimes = stopTimes;
                    db.noticias = noticias.sort((a, b) => new Date(b.fecha_publicacion) - new Date(a.fecha_publicacion));
                    // NUEVO: Procesar tarifas con valor num칠rico
                    tarifas.forEach(t => db.tarifas.set(t.route_id, {
                        num: t.tarifa_num || 0,
                        moneda: t.tipo_moneda || 'Bs.',
                        desc: t.descripcion_tarifa
                    }));
                    
                    shapes.forEach(p => {
                        if (!db.shapes.has(p.shape_id)) {
                            db.shapes.set(p.shape_id, []);
                        }
                        db.shapes.get(p.shape_id).push(p);
                    });
                    db.shapes.forEach(points => points.sort((a, b) => a.shape_pt_sequence - b.shape_pt_sequence));
                    
                    logDebug("Creando 칤ndice de stop_times...", 'info');
                    db.stopTimes.forEach(st => {
                        if (!db.stopTimesPorParada.has(st.stop_id)) {
                            db.stopTimesPorParada.set(st.stop_id, []);
                        }
                        db.stopTimesPorParada.get(st.stop_id).push(st);
                    });
                    logDebug(`칈ndice creado para ${db.stopTimesPorParada.size} paradas.`, 'ok');

                    logDebug("Base de datos en memoria creada.", 'ok');
                    dom.estadoCarga.style.display = "none";
                    
                    renderizarNovedadesGenerales();
                    renderizarFiltroAgencias();
                    renderizarListaRutas('all');
                    iniciarReloj();
                    configurarNavegacion();
                    popularDropdownsPlanificador();
                    renderizarDirectorioParadas(); // <-- NUEVO


                } catch (error) {
                    console.error("Error fatal en main():", error);
                    dom.estadoCarga.textContent = `Error al cargar: ${error.message}`;
                    dom.estadoCarga.className = "status-error";
                    logDebug(error.message, 'error');
                }
            }

            // --- NAVEGACI칍N ---
            
            function mostrarVisor(visorId) {
                // Ocultar todos los visores
                dom.visorHorarios.style.display = 'none';
                dom.visorMapa.style.display = 'none';
                dom.visorPlanificador.style.display = 'none';
                dom.visorReportes.style.display = 'none';
                dom.visorAcercaDe.style.display = 'none';
                dom.visorDesarrollo.style.display = 'none';
                dom.visorCercaDeMi.style.display = 'none';
                dom.visorDirectorio.style.display = 'none';

                
                // Quitar 'active' de todos los botones
                dom.btnHorarios.classList.remove('active');
                dom.btnMapa.classList.remove('active');
                dom.btnPlanificador.classList.remove('active');
                dom.btnReportes.classList.remove('active');
                dom.btnAcercaDe.classList.remove('active');
                dom.btnCercaDeMiNav.classList.remove('active');
                dom.btnDesarrollo.classList.remove('active');
                dom.btnDirectorio.classList.remove('active');


                if (visorId === 'visor-mapa') {
                    dom.visorMapa.style.display = 'block';
                    dom.btnMapa.classList.add('active');
                    
                    requestAnimationFrame(() => {
                        if (!estadoApp.mapaInicializado) {
                            iniciarMapaGoogle();
                            renderizarTodasLasRutasEnMapa(); 
                            renderizarTodasLasParadasEnMapa(); 
                            estadoApp.mapaInicializado = true;
                        }
                    });

                } else if (visorId === 'visor-planificador') {
                    dom.visorPlanificador.style.display = 'block';
                    dom.btnPlanificador.classList.add('active');
                }
                else if (visorId === 'visor-reportes') {
                    dom.visorReportes.style.display = 'block';
                    dom.btnReportes.classList.add('active');
                }
                else if (visorId === 'visor-acerca-de') {
                    dom.visorAcercaDe.style.display = 'block';
                    dom.btnAcercaDe.classList.add('active');
                }
                else if (visorId === 'visor-desarrollo') {
                    dom.visorDesarrollo.style.display = 'block';
                    dom.btnDesarrollo.classList.add('active');
                }
                else if (visorId === 'visor-cerca-de-mi') {
                    dom.visorCercaDeMi.style.display = 'block';
                    dom.btnCercaDeMiNav.classList.add('active');
                }
                else if (visorId === 'visor-directorio') {
                    dom.visorDirectorio.style.display = 'block';
                    dom.btnDirectorio.classList.add('active');
                }
                else { // 'visor-horarios' es el default
                    dom.visorHorarios.style.display = 'flex';
                    dom.btnHorarios.classList.add('active');
                }
            }

            function mostrarPanelHorarios(panelId) {
                // --- L칍GICA DE PANEL DESLIZANTE ---
                if (!esMovil()) {
                    // En PC, no hacer nada, los paneles son fijos
                    return;
                }
                
                // Quitar todas las clases de estado
                dom.visorHorarios.classList.remove('show-paradas', 'show-detalles');
                
                if (panelId === 'show-paradas') {
                    dom.visorHorarios.classList.add('show-paradas');
                } else if (panelId === 'show-detalles') {
                    dom.visorHorarios.classList.add('show-paradas', 'show-detalles');
                }
                // Si panelId es 'panel-rutas' (o nulo), no se a침ade ninguna clase
            }
            
            function configurarNavegacion() {
                dom.btnHorarios.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-horarios'); });
                dom.btnMapa.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-mapa'); });
                dom.btnPlanificador.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-planificador'); });
                dom.btnReportes.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-reportes'); });
                dom.btnAcercaDe.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-acerca-de'); });
                dom.btnDesarrollo.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-desarrollo'); });
                dom.btnCercaDeMiNav.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-cerca-de-mi'); });
                dom.btnDirectorio.addEventListener('click', (e) => { e.preventDefault(); mostrarVisor('visor-directorio'); });

            
                // Navegaci칩n deslizante (m칩vil)
                dom.backARutas.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    dom.visorHorarios.classList.remove('show-paradas', 'show-detalles'); 
                });
                dom.backAParadas.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    dom.visorHorarios.classList.remove('show-detalles'); 
                });
                
                dom.btnBuscarRuta.addEventListener('click', buscarRutaGTFS);
                dom.btnBuscarCercanas.addEventListener('click', buscarParadasCercanas);
            }
            
            // --- FUNCIONES DE MAPA (GOOGLE MAPS) ---
            
            function iniciarMapaGoogle() {
                logDebug("Inicializando Google Maps...");
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    logDebug("ERROR: La API de Google Maps no se ha cargado. 쮽alta la API Key o es inv치lida?", 'error');
                    dom.visorMapa.innerHTML = `<h2 style="padding: 20px; color: red;">Error: No se pudo cargar Google Maps. Verifique su API Key.</h2>`;
                    return;
                }
                
                const mapCenter = { lat: 9.5, lng: -69.5 }; // Centro de Venezuela
                estadoApp.googleMap = new google.maps.Map(document.getElementById('mapa-principal'), {
                    zoom: 7,
                    center: mapCenter,
                    mapTypeId: 'roadmap',
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapTypeControl: true,
                    streetViewControl: false
                });
                
                logDebug("Google Maps inicializado.", 'ok');
            }
            
            function renderizarTodasLasRutasEnMapa() {
                const colores = ['#0d6efd', '#dc3545', '#198754', '#ffc107', '#0dcaf0', '#fd7e14'];
                let colorIndex = 0;
                let groupBounds = new google.maps.LatLngBounds();

                db.shapes.forEach((points, shapeId) => {
                    const latLngs = points.map(p => ({ lat: p.shape_pt_lat, lng: p.shape_pt_lon }));
                    const color = colores[colorIndex % colores.length];
                    
                    const polyline = new google.maps.Polyline({
                        path: latLngs,
                        strokeColor: color,
                        strokeOpacity: 0.8,
                        strokeWeight: 5,
                        map: estadoApp.googleMap
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({ content: `Ruta: ${shapeId}` });
                    polyline.addListener('click', (e) => {
                        infoWindow.setPosition(e.latLng);
                        infoWindow.open(estadoApp.googleMap);
                    });

                    latLngs.forEach(latLng => groupBounds.extend(latLng));
                    colorIndex++;
                });
                
                if (!groupBounds.isEmpty()) {
                    estadoApp.googleMap.fitBounds(groupBounds);
                }
                logDebug(`Renderizadas ${db.shapes.size} rutas en Google Maps.`, 'ok');
            }

            function renderizarTodasLasParadasEnMapa() {
                db.stops.forEach(stop => {
                    const marker = new google.maps.Marker({
                        position: { lat: stop.stop_lat, lng: stop.stop_lon },
                        map: estadoApp.googleMap,
                        title: stop.stop_name
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<b>${stop.stop_name}</b>`
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(estadoApp.googleMap, marker);
                    });
                });
                logDebug(`Renderizadas ${db.stops.size} paradas en Google Maps.`, 'ok');
            }
            
            // --- L칍GICA DE TIEMPO Y C츼LCULO ---
            function aSegundos(horaStr) {
                if (!horaStr || typeof horaStr !== 'string' || horaStr.split(':').length < 3) return 0;
                try {
                    const [h, m, s] = horaStr.split(':').map(Number);
                    return (h * 3600) + (m * 60) + s;
                } catch (e) { return 0; }
            }
            
            function segundosAFormato(seg) {
                const horas = Math.floor(seg / 3600);
                const minutos = Math.floor((seg % 3600) / 60);
                return `${horas}h ${minutos}min`;
            }
            
            function getDistanciaHaversine(lat1, lon1, lat2, lon2) {
                function toRad(x) {
                    return x * Math.PI / 180;
                }
                const R = 6371;
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function iniciarReloj() {
                dom.relojContainer.style.display = "block";
                
                const actualizarHora = () => {
                    const ahora = new Date();
                    
                    const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: db.agencyTimezone };
                    const horaFormato = new Intl.DateTimeFormat('es-VE', opcionesHora).format(ahora);
                    
                    const opcionesDia = { weekday: 'long', timeZone: db.agencyTimezone };
                    const diaNombreConAcento = new Intl.DateTimeFormat('es-VE', opcionesDia).format(ahora);
                    const diaNombreLimpio = diaNombreConAcento.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    estadoApp.diaActualGTFS_Field = diasSemanaGTFS[diaNombreLimpio] || 'monday';
                    
                    const ymdFormatter = new Intl.DateTimeFormat('en-CA', { timeZone: db.agencyTimezone, year: 'numeric', month: '2-digit', day: '2-digit' });
                    const [y, m, d] = ymdFormatter.format(ahora).split('-');
                    estadoApp.fechaActualYYYYMMDD = parseInt(`${y}${m}${d}`, 10);
                    
                    dom.relojDia.textContent = diaNombreConAcento.charAt(0).toUpperCase() + diaNombreConAcento.slice(1);
                    dom.relojHora.textContent = horaFormato;
                    
                    if (estadoApp.paradaActiva) {
                        renderizarHorarios(estadoApp.paradaActiva, true);
                    }
                };
                
                if (relojIntervalo) clearInterval(relojIntervalo);
                actualizarHora();
                relojIntervalo = setInterval(actualizarHora, 1000);
            }

            // --- RENDERIZADO (VISOR HORARIOS) ---
            
            function crearHtmlNovedad(novedad) {
                const tipo = novedad.tipo || 'INFO';
                const titulo = novedad.trip_headsign 
                    ? `${novedad.titulo} (${novedad.trip_headsign})`
                    : novedad.titulo;
                
                return `
                    <div class="novedad-item tipo-${tipo}">
                        <strong><span class="chip tipo-${tipo}">${tipo}</span>${titulo}</strong>
                        <p>${novedad.descripcion}</p>
                    </div>
                `;
            }

            function renderizarNovedadesGenerales() {
                const noticiasGenerales = db.noticias.filter(n => !n.route_id);
                if (noticiasGenerales.length > 0) {
                    dom.novedadesGeneralesLista.innerHTML = noticiasGenerales.map(crearHtmlNovedad).join('');
                    dom.novedadesGeneralesContainer.style.display = 'block';
                } else {
                    dom.novedadesGeneralesContainer.style.display = 'none';
                }
            }
            
            function renderizarNovedadesDeRuta(routeId) {
                const noticiasDeRuta = db.noticias.filter(n => n.route_id === routeId);
                if (noticiasDeRuta.length > 0) {
                    dom.novedadesRutaLista.innerHTML = noticiasDeRuta.map(crearHtmlNovedad).join('');
                    dom.novedadesRutaContainer.style.display = 'block';
                } else {
                    dom.novedadesRutaContainer.style.display = 'none';
                }
            }
            
            function renderizarFiltroAgencias() {
                dom.agencyFilterContainer.innerHTML = '';
                
                const btnTodas = document.createElement('button');
                btnTodas.className = 'agency-filter-btn active';
                btnTodas.textContent = 'Todas';
                btnTodas.dataset.agencyId = 'all';
                btnTodas.addEventListener('click', () => {
                    renderizarListaRutas('all');
                    document.querySelectorAll('.agency-filter-btn').forEach(b => b.classList.remove('active'));
                    btnTodas.classList.add('active');
                });
                dom.agencyFilterContainer.appendChild(btnTodas);

                db.agencies.forEach(agency => {
                    const btn = document.createElement('button');
                    btn.className = 'agency-filter-btn';
                    btn.textContent = agency.agency_name;
                    btn.dataset.agencyId = agency.agency_id;
                    btn.addEventListener('click', () => {
                        renderizarListaRutas(agency.agency_id);
                        document.querySelectorAll('.agency-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                    dom.agencyFilterContainer.appendChild(btn);
                });
            }

            function renderizarListaRutas(agencyId = 'all') {
                dom.listaRutas.innerHTML = '';
                
                const rutasAMostrar = (agencyId === 'all')
                    ? [...db.routes.values()]
                    : [...db.routes.values()].filter(r => r.agency_id === agencyId);
                
                if (rutasAMostrar.length === 0) {
                    dom.listaRutas.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-texto-secundario);">No se encontraron rutas para esta agencia.</div>';
                    return;
                }

                rutasAMostrar.forEach(route => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游뚧</span>
                        <div>
                            <strong>${route.route_short_name || 'Ruta'}</strong>
                            <span>${route.route_long_name}</span>
                        </div>
                    `;
                    div.addEventListener('click', () => {
                        document.querySelectorAll('#lista-rutas .list-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        estadoApp.rutaActiva = route.route_id;
                        logDebug(`Ruta seleccionada: ${route.route_long_name}`, 'info');
                        
                        renderizarNovedadesDeRuta(route.route_id);
                        renderizarListaParadasDeRuta(route.route_id);
                    });
                    dom.listaRutas.appendChild(div);
                });
            }

            function renderizarListaParadasDeRuta(routeId) {
                const route = db.routes.get(routeId);
                dom.paradasTitulo.textContent = `游늸 Paradas de ${route.route_short_name}`;

                const tarifaInfo = db.tarifas.get(routeId);
                if (tarifaInfo) {
                    dom.tarifaDescripcion.textContent = tarifaInfo.desc;
                    dom.tarifaInfo.style.display = 'block';
                } else {
                    dom.tarifaInfo.style.display = 'none';
                }

                const viajesRuta = [...db.trips.values()].filter(t => t.route_id === routeId);
                const idsViajesRuta = new Set(viajesRuta.map(t => t.trip_id));
                
                const idsParadas = new Set();
                const paradasOrdenadas = [];
                let primerViajeIda = viajesRuta.find(t => t.direction_id === 0)?.trip_id;
                if (!primerViajeIda) {
                    primerViajeIda = viajesRuta.length > 0 ? viajesRuta[0].trip_id : null;
                }
                
                if(primerViajeIda) {
                    db.stopTimes
                        .filter(st => st.trip_id === primerViajeIda)
                        .sort((a,b) => a.stop_sequence - b.stop_sequence)
                        .forEach(st => {
                            if (!idsParadas.has(st.stop_id)) {
                                paradasOrdenadas.push(st.stop_id);
                                idsParadas.add(st.stop_id);
                            }
                        });
                }
                
                dom.listaParadas.innerHTML = '';
                paradasOrdenadas.forEach(stopId => {
                    const stop = db.stops.get(stopId);
                    if (!stop) return;
                    
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游늸</span>
                        <div><strong>${stop.stop_name}</strong></div>
                    `;
                    div.addEventListener('click', () => {
                        document.querySelectorAll('#lista-paradas .list-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        estadoApp.paradaActiva = stop.stop_id;
                        logDebug(`Parada seleccionada: ${stop.stop_name}`, 'info');
                        renderizarHorarios(stop.stop_id, false);
                    });
                    dom.listaParadas.appendChild(div);
                });
                
                dom.detallesPlaceholder.style.display = "block";
                dom.horariosLista.innerHTML = '';
                dom.proximoResumen.style.display = 'none';
                dom.tituloListaHorarios.style.display = 'none';
                dom.otrasRutasContainer.style.display = 'none';
                
                mostrarPanelHorarios('show-paradas'); // <-- MODIFICADO: Usa la clase
            }
            
            function renderizarOtrasRutas(stopId) {
                const stopTimes = db.stopTimesPorParada.get(stopId) || [];
                const tripIds = new Set(stopTimes.map(st => st.trip_id));
                
                const routeIds = new Set();
                tripIds.forEach(tid => {
                    const trip = db.trips.get(tid);
                    if (trip) routeIds.add(trip.route_id);
                });

                let html = '';
                let count = 0;
                routeIds.forEach(routeId => {
                    if (routeId && routeId !== estadoApp.rutaActiva) {
                        const route = db.routes.get(routeId);
                        if(route) {
                            html += `
                                <div class="otra-ruta-item">
                                    <span class="icon">游뚧</span>
                                    <span>${route.route_short_name} - ${route.route_long_name}</span>
                                </div>
                            `;
                            count++;
                        }
                    }
                });

                if (count > 0) {
                    dom.otrasRutasLista.innerHTML = html;
                    dom.otrasRutasContainer.style.display = 'block';
                } else {
                    dom.otrasRutasContainer.style.display = 'none';
                }
            }

            function renderizarHorarios(stopId, esRefresco = false) {
                if (!esRefresco) {
                    const stop = db.stops.get(stopId);
                    dom.detallesTitulo.textContent = `游 ${stop.stop_name}`;
                    dom.detallesPlaceholder.style.display = "none";
                    dom.horariosLista.innerHTML = '';
                    dom.debugLog.innerHTML = 'Refrescando horarios...';
                    
                    renderizarOtrasRutas(stopId);
                    
                    mostrarPanelHorarios('show-detalles'); // <-- MODIFICADO: Usa la clase
                }

                const horaActualStr = dom.relojHora.textContent;
                const segundosActuales = aSegundos(horaActualStr);
                const diaActualField = estadoApp.diaActualGTFS_Field;
                const fechaActual = estadoApp.fechaActualYYYYMMDD;

                if (!esRefresco) {
                    logDebug(`Hora actual (${db.agencyTimezone}): ${horaActualStr} (${segundosActuales}s)`, 'info');
                    logDebug(`D칤a (campo GTFS): ${diaActualField}`, 'info');
                    logDebug(`Fecha (GTFS): ${fechaActual}`, 'info');
                }

                const idsViajesRutaActiva = new Set(
                    [...db.trips.values()]
                        .filter(t => t.route_id === estadoApp.rutaActiva)
                        .map(t => t.trip_id)
                );

                const horariosHoy = db.stopTimes
                    .filter(st => {
                        if (st.stop_id !== stopId) return false;
                        
                        // Si hay una ruta activa, filtrar por ella. Si no (ej. Cerca de M칤), mostrar todo.
                        if (estadoApp.rutaActiva && !idsViajesRutaActiva.has(st.trip_id)) return false;
                        
                        const trip = db.trips.get(st.trip_id);
                        if (!trip) return false;
                        
                        const calendario = db.calendar.get(trip.service_id);
                        if (!calendario) {
                            if (!esRefresco) logDebug(`ERROR: service_id "${trip.service_id}" (del trip "${trip.trip_id}") no se encuentra en calendar.txt`, 'error');
                            return false;
                        }

                        const esDiaValido = calendario[diaActualField] === 1;
                        const estaEnRango = fechaActual >= calendario.start_date && fechaActual <= calendario.end_date;

                        return esDiaValido && estaEnRango;
                    })
                    .map(st => {
                        const trip = db.trips.get(st.trip_id);
                        const route = db.routes.get(trip.route_id);
                        return {
                            hora: st.departure_time,
                            destino: trip.trip_headsign || "Sin destino",
                            rutaNombre: route.route_short_name
                        }
                    })
                    .sort((a, b) => a.hora.localeCompare(b.hora));

                const horariosUnicos = [];
                const visto = new Set();
                for (const h of horariosHoy) {
                    const id = h.hora + h.destino + h.rutaNombre;
                    if (!visto.has(id)) {
                        horariosUnicos.push(h);
                        visto.add(id);
                    }
                }
                
                if (!esRefresco) {
                    logDebug(`Se encontraron ${horariosUnicos.length} salidas 칰nicas para hoy.`, 'ok');
                }
                
                let proximoBus = null;
                for (const h of horariosUnicos) {
                    if (aSegundos(h.hora) > segundosActuales) {
                        proximoBus = h;
                        break;
                    }
                }

                // Definir t칤tulo
                const tituloHorarios = estadoApp.rutaActiva ? "Todos los Horarios (Ruta Actual)" : "Todos los Horarios (Todas las Rutas)";
                dom.tituloListaHorarios.textContent = tituloHorarios;
                const tituloProximo = estadoApp.rutaActiva ? "Pr칩ximo Autob칰s (Ruta Actual)" : "Pr칩ximo Autob칰s (Todas las Rutas)";
                dom.proximoResumen.querySelector('h3').textContent = tituloProximo;

                if (proximoBus) {
                    dom.proximoHora.textContent = proximoBus.hora;
                    dom.proximoDestino.innerHTML = estadoApp.rutaActiva ? proximoBus.destino : `<strong>${proximoBus.rutaNombre}:</strong> ${proximoBus.destino}`;
                    dom.proximoResumen.style.display = 'block';
                    dom.tituloListaHorarios.style.display = 'block';
                    if (!esRefresco) logDebug(`Pr칩ximo bus: ${proximoBus.hora}`, 'ok');
                } else {
                    dom.proximoResumen.style.display = 'none';
                    dom.tituloListaHorarios.style.display = 'none';
                }

                dom.horariosLista.innerHTML = '';
                let busesPasados = 0;
                
                horariosUnicos.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'horario-item';
                    
                    const segundosBus = aSegundos(h.hora);
                    
                    if (proximoBus && h.hora === proximoBus.hora && h.destino === proximoBus.destino) {
                        div.classList.add('proximo');
                    }
                    
                    if (segundosBus <= segundosActuales) {
                        busesPasados++;
                    }
                    
                    // Mostrar ruta si no hay ruta activa
                    const destinoHtml = estadoApp.rutaActiva 
                        ? h.destino 
                        : `<strong>${h.rutaNombre}:</strong> ${h.destino}`;
                    
                    div.innerHTML = `
                        <span class="hora">${h.hora}</span>
                        <span class="destino">${destinoHtml}</span>
                    `;
                    dom.horariosLista.appendChild(div);
                });
                
                const msgSinMasSalidas = 'No hay m치s salidas programadas para hoy.';
                const msgSinSalidasHoy = `No hay salidas programadas para hoy (verifique el d칤a y el rango de fechas del servicio).`;
                
                if (!proximoBus && horariosUnicos.length > 0) {
                     dom.horariosLista.innerHTML = `<div class="horario-item" style="text-align: center; color: var(--color-texto-secundario); padding: 20px 0;">${msgSinMasSalidas}</div>`;
                     if (!esRefresco) logDebug(msgSinMasSalidas, 'warn');
                } else if (horariosUnicos.length === 0) {
                     dom.horariosLista.innerHTML = `<div class="horario-item" style="text-align: center; color: var(--color-texto-secundario); padding: 20px 0;">${msgSinSalidasHoy}</div>`;
                     if (!esRefresco) logDebug(msgSinSalidasHoy, 'warn');
                }
            }
            
            // --- NUEVAS FUNCIONES (GEOLOCALIZACI칍N Y REPORTES) ---

            function buscarParadasCercanas() {
                if (!navigator.geolocation) {
                    dom.cercanasStatus.textContent = "Tu navegador no soporta geolocalizaci칩n.";
                    dom.cercanasStatus.style.color = "red";
                    return;
                }
                
                dom.cercanasStatus.textContent = "Obteniendo tu ubicaci칩n...";
                dom.cercanasStatus.style.color = "var(--color-texto-secundario)";
                dom.cercanasResultadosLista.innerHTML = "";
                
                navigator.geolocation.getCurrentPosition(
                    (posicion) => {
                        const lat = posicion.coords.latitude;
                        const lon = posicion.coords.longitude;
                        logDebug(`Ubicaci칩n obtenida: ${lat}, ${lon}`, 'ok');
                        
                        const paradasCercanas = [...db.stops.values()]
                            .map(stop => {
                                const dist = getDistanciaHaversine(lat, lon, stop.stop_lat, stop.stop_lon);
                                return { ...stop, dist }; // A침adir distancia al objeto
                            })
                            .filter(stop => stop.dist <= MAX_DISTANCIA_CERCANA_KM)
                            .sort((a, b) => a.dist - b.dist);
                        
                        renderizarParadasCercanas(paradasCercanas);
                    },
                    (error) => {
                        logDebug(`Error de geolocalizaci칩n: ${error.message}`, 'error');
                        dom.cercanasStatus.textContent = "No se pudo obtener tu ubicaci칩n. Por favor, revisa los permisos.";
                        dom.cercanasStatus.style.color = "red";
                    }
                );
            }
            
            function renderizarParadasCercanas(paradas) {
                if (paradas.length === 0) {
                    dom.cercanasStatus.textContent = `No se encontraron paradas en un radio de ${MAX_DISTANCIA_CERCANA_KM} km.`;
                    dom.cercanasStatus.style.color = "var(--color-texto-secundario)";
                    return;
                }
                
                dom.cercanasStatus.textContent = `Se encontraron ${paradas.length} paradas:`;
                dom.cercanasStatus.style.color = "var(--color-exito-texto)";
                
                paradas.forEach(stop => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游늸</span>
                        <div>
                            <strong>${stop.stop_name}</strong>
                            <span>Aprox. ${stop.dist.toFixed(2)} km de distancia</span>
                        </div>
                    `;
                    div.addEventListener('click', () => {
                        // Al hacer clic, ir a la pesta침a Horarios y mostrar los horarios de esa parada
                        estadoApp.paradaActiva = stop.stop_id;
                        estadoApp.rutaActiva = null; // Mostrar todas las rutas
                        renderizarHorarios(stop.stop_id, false);
                        mostrarVisor('visor-horarios');
                        mostrarPanelHorarios('show-detalles'); // Forzar vista de detalles en m칩vil
                    });
                    dom.cercanasResultadosLista.appendChild(div);
                });
            }
            

  /** Rellena la lista del Directorio de Paradas */
            function renderizarDirectorioParadas() {
                const paradasOrdenadas = [...db.stops.values()].sort((a, b) => a.stop_name.localeCompare(b.stop_name));
                
                dom.directorioParadasLista.innerHTML = ''; // Limpiar
                
                paradasOrdenadas.forEach(stop => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="icon">游늸</span>
                        <div><strong>${stop.stop_name}</strong></div>
                    `;
                    div.addEventListener('click', () => {
                        document.querySelectorAll('#directorio-paradas-lista .list-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                        mostrarDetalleDeParada(stop.stop_id);
                    });
                    dom.directorioParadasLista.appendChild(div);
                });
            }

            /** Muestra el mapa y las rutas para una parada del directorio */
            function mostrarDetalleDeParada(stopId) {
                const stop = db.stops.get(stopId);
                if (!stop) return;

                dom.directorioDetalleTitulo.textContent = stop.stop_name;
                
                // 1. Mostrar Rutas
                const stopTimes = db.stopTimesPorParada.get(stopId) || [];
                const tripIds = new Set(stopTimes.map(st => st.trip_id));
                const routeIds = new Set();
                tripIds.forEach(tid => {
                    const trip = db.trips.get(tid);
                    if (trip) routeIds.add(trip.route_id);
                });

                let html = '';
                let count = 0;
                routeIds.forEach(routeId => {
                    const route = db.routes.get(routeId);
                    if(route) {
                        html += `
                            <div class="otra-ruta-item">
                                <span class="icon">游뚧</span>
                                <span>${route.route_short_name} - ${route.route_long_name}</span>
                            </div>
                        `;
                        count++;
                    }
                });
                
                dom.directorioDetalleRutasLista.innerHTML = (count > 0) ? html : '<p>No hay rutas asignadas a esta parada.</p>';
                
                // 2. Mostrar Mapa
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    dom.directorioDetalleMapa.innerHTML = '<p style="color:red;padding:10px;">No se pudo cargar Google Maps.</p>';
                } else {
                    // Re-inicializar el mapa del directorio cada vez
                    const map = new google.maps.Map(dom.directorioDetalleMapa, {
                        zoom: 16,
                        center: { lat: stop.stop_lat, lng: stop.stop_lon },
                        mapTypeId: 'roadmap',
                        disableDefaultUI: true,
                        zoomControl: true
                    });
                    
                    new google.maps.Marker({
                        position: { lat: stop.stop_lat, lng: stop.stop_lon },
                        map: map,
                        title: stop.stop_name
                    });
                }

                // 3. Mostrar contenedor
                dom.directorioDetalleContainer.style.display = 'block';
            }
            

            // --- PLANIFICADOR (v3 - TRANSBORDO ESPACIAL/TEMPORAL) ---
            
            function popularDropdownsPlanificador() {
                const paradasOrdenadas = [...db.stops.values()].sort((a, b) => a.stop_name.localeCompare(b.stop_name));
                
                paradasOrdenadas.forEach(stop => {
                    const optionOrigen = document.createElement('option');
                    optionOrigen.value = stop.stop_id;
                    optionOrigen.textContent = stop.stop_name;
                    dom.planOrigen.appendChild(optionOrigen);
                    
                    const optionDestino = document.createElement('option');
                    optionDestino.value = stop.stop_id;
                    optionDestino.textContent = stop.stop_name;
                    dom.planDestino.appendChild(optionDestino);
                });
                logDebug("Dropdowns de planificador populados.", 'ok');
            }
            
            function getDatosDeTiempo(dayOffset = 0) {
                const ahora = new Date();
                if (dayOffset > 0) {
                    ahora.setDate(ahora.getDate() + dayOffset);
                }
                
                const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: db.agencyTimezone };
                const horaFormato = new Intl.DateTimeFormat('es-VE', opcionesHora).format(ahora);
                
                const opcionesDia = { weekday: 'long', timeZone: db.agencyTimezone };
                const diaNombreConAcento = new Intl.DateTimeFormat('es-VE', opcionesDia).format(ahora);
                const diaNombreLimpio = diaNombreConAcento.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                
                const diaField = diasSemanaGTFS[diaNombreLimpio] || 'monday';
                
                const ymdFormatter = new Intl.DateTimeFormat('en-CA', { timeZone: db.agencyTimezone, year: 'numeric', month: '2-digit', day: '2-digit' });
                const [y, m, d] = ymdFormatter.format(ahora).split('-');
                const fechaYYYYMMDD = parseInt(`${y}${m}${d}`, 10);
                
                const segundosInicio = (dayOffset > 0) ? 0 : aSegundos(horaFormato);
                
                return {
                    segundosInicio,
                    diaField,
                    fechaYYYYMMDD,
                    diaNombre: diaNombreConAcento.charAt(0).toUpperCase() + diaNombreConAcento.slice(1)
                };
            }
            
            function esViajeValido(tripId, diaField, fecha) {
                const trip = db.trips.get(tripId);
                if (!trip) return false;
                
                const calendario = db.calendar.get(trip.service_id);
                if (!calendario) return false;
                
                const esDiaValido = calendario[diaField] === 1;
                const estaEnRango = fecha >= calendario.start_date && fecha <= calendario.end_date;
                
                return esDiaValido && estaEnRango;
            }

            function encontrarRutasDirectas(origenId, destinoId, tiempo) {
                const { segundosInicio, diaField, fechaYYYYMMDD } = tiempo;
                let resultados = [];
                
                const salidasPosibles = db.stopTimesPorParada.get(origenId) || [];

                for (const stOrigen of salidasPosibles) {
                    const segundosSalida = aSegundos(stOrigen.departure_time);
                    if (segundosSalida < segundosInicio) continue;
                    if (!esViajeValido(stOrigen.trip_id, diaField, fechaYYYYMMDD)) continue;
                    
                    const stDestino = db.stopTimes.find(st => 
                        st.trip_id === stOrigen.trip_id && 
                        st.stop_id === destinoId &&
                        st.stop_sequence > stOrigen.stop_sequence
                    );
                    
                    if (stDestino) {
                        const trip = db.trips.get(stOrigen.trip_id);
                        const route = db.routes.get(trip.route_id);
                        const segundosLlegada = aSegundos(stDestino.arrival_time);
                        const tarifaInfo = db.tarifas.get(route.route_id) || { num: 0, moneda: 'Bs.' };
                        
                        resultados.push({
                            tipo: 'directo',
                            tramos: [{
                                rutaNombre: route.route_short_name,
                                rutaCompleta: route.route_long_name,
                                destinoViaje: trip.trip_headsign,
                                horaSalida: stOrigen.departure_time,
                                segundosSalida: segundosSalida,
                                paradaOrigen: db.stops.get(origenId).stop_name,
                                horaLlegada: stDestino.arrival_time,
                                segundosLlegada: segundosLlegada,
                                paradaDestino: db.stops.get(destinoId).stop_name,
                                duracion: segundosAFormato(segundosLlegada - segundosSalida),
                                tarifa: tarifaInfo.num,
                                moneda: tarifaInfo.moneda
                            }],
                            segundosLlegadaFinal: segundosLlegada
                        });
                    }
                }
                return resultados;
            }
            
            function encontrarRutasConTransbordo(origenId, destinoId, tiempo) {
                const { segundosInicio, diaField, fechaYYYYMMDD } = tiempo;
                let resultados = [];
                
                const salidasTramo1 = db.stopTimesPorParada.get(origenId) || [];

                // TRAMO 1
                for (const stOrigen of salidasTramo1) {
                    const segundosSalida1 = aSegundos(stOrigen.departure_time);
                    if (segundosSalida1 < segundosInicio) continue;
                    if (!esViajeValido(stOrigen.trip_id, diaField, fechaYYYYMMDD)) continue;
                    
                    const trip1 = db.trips.get(stOrigen.trip_id);
                    const route1 = db.routes.get(trip1.route_id);
                    const tarifaInfo1 = db.tarifas.get(route1.route_id) || { num: 0, moneda: 'Bs.' };

                    const paradasTramo1 = db.stopTimes.filter(st => 
                        st.trip_id === stOrigen.trip_id && 
                        st.stop_sequence > stOrigen.stop_sequence
                    );
                    
                    for (const stTransbordo1 of paradasTramo1) {
                        const paradaB_Id = stTransbordo1.stop_id;
                        if (paradaB_Id === destinoId) continue; 
                        
                        const paradaB_Coords = db.stops.get(paradaB_Id);
                        const segundosLlegada1 = aSegundos(stTransbordo1.arrival_time);
                        
                        // TRAMO 2: Buscar paradas cercanas
                        for (const paradaD of db.stops.values()) {
                            if (paradaD.stop_id === origenId) continue;
                            
                            const dist = getDistanciaHaversine(paradaB_Coords.stop_lat, paradaB_Coords.stop_lon, paradaD.stop_lat, paradaD.stop_lon);
                            
                            if (dist <= MAX_DISTANCIA_TRANSBORDO_KM) {
                                
                                // Buscar conexi칩n en los pr칩ximos d칤as
                                for (let diaOffset2 = 0; diaOffset2 < 7; diaOffset2++) {
                                    // El tiempo2 debe estar basado en el d칤a de LLEGADA del tramo 1
                                    const tiempoLlegada1 = getDatosDeTiempo(0); // Tomamos la fecha de hoy
                                    tiempoLlegada1.fechaYYYYMMDD = fechaYYYYMMDD;
                                    
                                    // Ajustar si la llegada es > 24:00:00 (l칩gica GTFS)
                                    if(segundosLlegada1 >= 86400) {
                                        // TODO: Implementar l칩gica de fecha de servicio avanzada
                                        // Por ahora, asumimos que la llegada es el mismo d칤a de salida
                                    }

                                    const tiempo2 = getDatosDeTiempo(diaOffset2); // (diaOffset se refiere a HOY + X d칤as)
                                    
                                    if (tiempo2.fechaYYYYMMDD < tiempoLlegada1.fechaYYYYMMDD) continue; // D칤a ya pas칩
                                    
                                    let segundosInicio2 = 0;
                                    if (tiempo2.fechaYYYYMMDD === tiempoLlegada1.fechaYYYYMMDD) {
                                        segundosInicio2 = segundosLlegada1 + MIN_TIEMPO_TRANSBORDO_SEGUNDOS;
                                    }
                                    
                                    const salidasTramo2 = db.stopTimesPorParada.get(paradaD.stop_id) || [];
                                    
                                    for (const stOrigen2 of salidasTramo2) {
                                        const segundosSalida2 = aSegundos(stOrigen2.departure_time);
                                        
                                        if (segundosSalida2 < segundosInicio2) continue;
                                        if (!esViajeValido(stOrigen2.trip_id, tiempo2.diaField, tiempo2.fechaYYYYMMDD)) continue;
                                        
                                        const stDestinoFinal = db.stopTimes.find(st => 
                                            st.trip_id === stOrigen2.trip_id &&
                                            st.stop_id === destinoId &&
                                            st.stop_sequence > stOrigen2.stop_sequence
                                        );
                                        
                                        if (stDestinoFinal) {
                                            const trip2 = db.trips.get(stOrigen2.trip_id);
                                            const route2 = db.routes.get(trip2.route_id);
                                            const segundosLlegada2 = aSegundos(stDestinoFinal.arrival_time);
                                            const tarifaInfo2 = db.tarifas.get(route2.route_id) || { num: 0, moneda: 'Bs.' };
                                            
                                            // Calcular d칤as de espera
                                            let fecha1 = new Date(tiempoLlegada1.fechaYYYYMMDD.toString().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                                            let fecha2 = new Date(tiempo2.fechaYYYYMMDD.toString().replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
                                            const diffTime = Math.abs(fecha2 - fecha1);
                                            const diasEspera = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                                            
                                            const segundosEsperaTotal = (diasEspera * 86400) + segundosSalida2 - segundosLlegada1;

                                            resultados.push({
                                                tipo: 'transbordo',
                                                tramos: [
                                                    { 
                                                        rutaNombre: route1.route_short_name,
                                                        rutaCompleta: route1.route_long_name,
                                                        destinoViaje: trip1.trip_headsign,
                                                        horaSalida: stOrigen.departure_time,
                                                        paradaOrigen: db.stops.get(origenId).stop_name,
                                                        horaLlegada: stTransbordo1.arrival_time,
                                                        paradaDestino: paradaB_Coords.stop_name,
                                                        duracion: segundosAFormato(segundosLlegada1 - segundosSalida1),
                                                        tarifa: tarifaInfo1.num,
                                                        moneda: tarifaInfo1.moneda
                                                    },
                                                    {
                                                        rutaNombre: route2.route_short_name,
                                                        rutaCompleta: route2.route_long_name,
                                                        destinoViaje: trip2.trip_headsign,
                                                        horaSalida: stOrigen2.departure_time,
                                                        paradaOrigen: paradaD.stop_name,
                                                        horaLlegada: stDestinoFinal.arrival_time,
                                                        paradaDestino: db.stops.get(destinoId).stop_name,
                                                        duracion: segundosAFormato(segundosLlegada2 - segundosSalida2),
                                                        tarifa: tarifaInfo2.num,
                                                        moneda: tarifaInfo2.moneda
                                                    }
                                                ],
                                                paradaTransbordo: paradaB_Coords.stop_name,
                                                paradaTransbordo2: paradaD.stop_name,
                                                distanciaTransbordo: dist.toFixed(2),
                                                tiempoEspera: segundosAFormato(segundosEsperaTotal),
                                                diasEspera: diasEspera,
                                                segundosLlegadaFinal: (diasEspera * 86400) + segundosLlegada2
                                            });
                                            
                                            break; 
                                        }
                                    }
                                    if (resultados.length > 0 && resultados[resultados.length-1].tipo === 'transbordo') break;
                                }
                            }
                        }
                    }
                }
                return resultados;
            }

            function buscarRutaGTFS() {
                const origenId = dom.planOrigen.value;
                const destinoId = dom.planDestino.value;
                
                dom.planResultados.innerHTML = '';
                logDebug(`Buscando ruta de ${origenId} a ${destinoId}...`, 'info');

                if (!origenId || !destinoId || origenId === destinoId) {
                    dom.planResultados.innerHTML = `<h3 style="color: var(--color-alerta-texto); text-align: center;">Por favor seleccione un origen y un destino v치lidos.</h3>`;
                    return;
                }
                
                let todosLosResultados = [];
                let diaBusqueda = 0; 
                
                while (diaBusqueda < 7) {
                    let tiempo = getDatosDeTiempo(diaBusqueda);
                    let diaNombre = (diaBusqueda === 0) ? "Hoy" : (diaBusqueda === 1) ? "Ma침ana" : tiempo.diaNombre;
                    
                    logDebug(`Buscando para ${diaNombre} (Offset: ${diaBusqueda}, D칤a: ${tiempo.diaField}, Fecha: ${tiempo.fechaYYYYMMDD})`, 'info');
                    
                    let resultadosDirectos = encontrarRutasDirectas(origenId, destinoId, tiempo);
                    let resultadosTransbordo = encontrarRutasConTransbordo(origenId, destinoId, tiempo);
                    
                    let resultadosDelDia = [...resultadosDirectos, ...resultadosTransbordo];
                    
                    if (resultadosDelDia.length > 0) {
                        resultadosDelDia.sort((a, b) => a.segundosLlegadaFinal - b.segundosLlegadaFinal);
                        
                        todosLosResultados.push({
                            diaNombre: diaNombre,
                            resultados: resultadosDelDia
                        });
                    }
                    
                    diaBusqueda++;
                }
                
                renderizarResultadosPlan(todosLosResultados);
            }
            
            function renderizarResultadosPlan(resultadosPorDia) {
                
                if (resultadosPorDia.length === 0) {
                    dom.planResultados.innerHTML = `<h3 style="color: var(--color-texto-secundario); text-align: center; margin-top: 40px;">
                        No se encontraron rutas que cumplan los criterios en los pr칩ximos 7 d칤as.
                    </h3>`;
                    logDebug("No se encontraron rutas.", 'warn');
                    return;
                }
                
                logDebug(`Renderizando ${resultadosPorDia.length} d칤as con resultados.`, 'ok');
                
                let html = ``;
                
                resultadosPorDia.forEach(diaData => {
                    let titulo = `Pr칩ximos Viajes (${diaData.diaNombre})`;
                    let esManana = diaData.diaNombre === "Ma침ana";
                    
                    html += `<h2 class="${esManana ? 'manana' : ''}">${titulo}</h2>`;
                    
                    diaData.resultados.slice(0, 3).forEach(r => {
                        
                        // --- C치lculo de Tarifa Total ---
                        let tarifas = {};
                        r.tramos.forEach(t => {
                            const moneda = t.moneda || 'Bs.';
                            if (!tarifas[moneda]) tarifas[moneda] = 0;
                            tarifas[moneda] += t.tarifa;
                        });
                        let tarifaStr = Object.keys(tarifas).map(moneda => 
                            `${tarifas[moneda].toFixed(2)} ${moneda}`
                        ).join(' + ');
                        if (tarifaStr === "0.00 Bs.") tarifaStr = "Consulte en taquilla";
                        // --- Fin C치lculo Tarifa ---
                        
                        html += `<div class="resultado-viaje">`;
                        
                        r.tramos.forEach((tramo, index) => {
                            html += `
                                <h3>
                                    游뚧 ${tramo.rutaNombre}: ${tramo.destinoViaje}
                                    <span class="tarifa-total">${index === 0 ? `Total Aprox: ${tarifaStr}` : ''}</span>
                                </h3>
                                <div class="detalles">
                                    <div>
                                        <span class="hora">${tramo.horaSalida}</span>
                                        <div class="parada">${tramo.paradaOrigen}</div>
                                    </div>
                                    <div class="duracion">
                                        俱
                                        <br>
                                        ${tramo.duracion}
                                    </div>
                                    <div style="text-align: right;">
                                        <span class="hora">${tramo.horaLlegada}</span>
                                        <div class="parada">${tramo.paradaDestino}</div>
                                    </div>
                                </div>
                            `;
                            
                            // Mostrar conector de transbordo
                            if (r.tipo === 'transbordo' && index < r.tramos.length - 1) {
                                let espera = (r.diasEspera > 0) ? ` (Espera de ${r.diasEspera} d칤a${r.diasEspera > 1 ? 's' : ''})` : ` (Espera: ${r.tiempoEspera})`;
                                let distancia = r.distanciaTransbordo > 0 ? `Caminar/Taxi ${r.distanciaTransbordo} km` : 'En la misma parada';
                                
                                html += `
                                    <div class="transbordo-conector">
                                        郊 Transbordo en <strong>${r.paradaTransbordo}</strong><br>
                                        <small>${distancia} a <strong>${r.paradaTransbordo2}</strong>${espera}</small> 郊
                                    </div>
                                `;
                            }
                        });
                        
                        html += `</div>`;
                    });
                });
                
                dom.planResultados.innerHTML = html;
            }
            

            // --- INICIAR ---
            main();
            window.addEventListener('resize', () => mostrarPanelHorarios(esMovil() ? 'panel-rutas' : 'panel-rutas'));
        });
    </script>
</body>
</html>